<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/icon.png">

<title>Download Absensi Mesin</title>
<style>
  /* Reset and Base Styles from your original flask.html */
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #4f46e5, #9333ea);
    color: white;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* --- Navigation Styles (Merged and Adapted for common-ui rendering) --- */
  nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      z-index: 10;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1); /* Added from previous suggestion */
  }
  nav .brand {
      font-weight: bold;
      font-size: 1.2rem;
      color: white; /* Ensure brand text is white */
  }

  /* Your original nav .menu was flex-grow: 1 and justify-content: center.
     We retain these, but also add gap for icon links. */
  nav .menu {
      display: flex;
      align-items: center;
      flex-grow: 1;
      justify-content: center;
      gap: 8px; /* Spacing between icon links */
  }

  /* Styling for individual menu icon links in the header */
  .menu-icon-link {
      position: relative;
      display: flex;
      flex-direction: column; /* Stack icon and text for hover effect */
      align-items: center;
      justify-content: center;
      padding: 6px 10px; /* Reduced padding */
      text-decoration: none;
      color: white; /* Ensure link color is white */
      transition: background-color 0.3s ease, color 0.3s ease;
  }

  .menu-icon-link:hover {
      background-color: rgba(255, 255, 255, 0.1); /* Subtle hover background */
      border-radius: 5px;
      color: #a5b4fc; /* Hover color from your original nav .menu a:hover */
  }

  /* Styling for the menu icons in the header */
  .menu-icon-link .menu-icon {
      width: 33px; /* Suggested size for header icons */
      height: 33px;
      object-fit: contain;
  }

  /* Styling for the hover text in the header */
  .menu-icon-link .menu-text {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0; /* KRITIS: Tersembunyi secara default */
      pointer-events: none; /* KRITIS: Tidak menghalangi interaksi mouse */
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      z-index: 1000;
      top: calc(100% + 5px); /* Position below the link */
      left: 50%;
      transform: translateX(-50%) translateY(5px); /* Initial position for fade-down effect */
  }

  /* Show hover text on link hover */
  .menu-icon-link:hover .menu-text {
      opacity: 1; /* KRITIS: Terlihat saat hover */
      transform: translateX(-50%) translateY(0); /* Move to final position */
  }

  /* Styling for the 'active' state in header navigation */
  .menu-icon-link.active {
      background-color: rgba(255, 255, 255, 0.2); /* Highlight active link */
      border-radius: 5px;
      color: #a5b4fc; /* Active color from your original nav .menu a.active */
  }

  .right-nav-items {
      display: flex;
      align-items: center;
      gap: 10px; /* Adjusted gap */
  }
  .user-info {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.8);
      white-space: nowrap;
  }
  nav .menu2 {
      color: white;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.1);
      transition: background 0.3s, transform 0.2s;
      font-weight: bold;
      font-size: 0.9em;
  }
  nav .menu2:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
  }

  /* --- Main Content and Form Styles (from your original flask.html) --- */
  .main-content-wrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
  }

  .container {
    background: rgba(255,255,255,0.1);
    padding: 2rem;
    border-radius: 1rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    backdrop-filter: blur(8px);
    animation: fadeIn .8s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  h2 { text-align: center; margin-top: 0; }

  input, select {
    width: 100%; padding: .75rem; margin-top: .5rem;
    border-radius: .5rem; border: none;
    background: rgba(255,255,255,0.15);
    color: white;
  }
  input::placeholder {
      color: rgba(255,255,255,0.6);
  }
  select option {
      background: #4f46e5;
      color: white;
  }
  input[type="file"] { background: none; color: white; }

  button {
    width: 100%; padding: .75rem; margin-top: .75rem;
    border: none; border-radius: .5rem;
    font-weight: bold; cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }
  button.green { background: #10b981; color: white; }
  button.blue { background: #3b82f6; color: white; }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }

  .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
      display: none;
  }
  .status-message.success { background-color: #10b981; color: white; display: block; }
  .status-message.error { background-color: #ef4444; color: white; display: block; }
  .status-message.info { background-color: #60a5fa; color: white; display: block; }

  /* --- Footer Styles (from your original flask.html) --- */
  footer {
      text-align: center;
      padding: 1rem;
      font-size: .9rem;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      box-shadow: 0 -2px 3px rgba(0,0,0,0.1); /* Added from previous suggestion */
  }
  footer a { color: white; text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  /* --- Media Queries (from your original flask.html) --- */
  @media (max-width: 768px) {
      nav {
          padding: 1rem;
          flex-direction: column;
          align-items: flex-start;
      }
      nav .brand { margin-bottom: 10px; }
      nav .menu {
          width: 100%;
          flex-wrap: wrap;
          justify-content: flex-start;
          margin-bottom: 10px;
          gap: 5px; /* Adjust gap for smaller screens */
      }
      .menu-icon-link { /* Adjust padding for smaller screens */
          padding: 5px 8px;
      }
      /* Your original nav .menu a { margin: 0.5rem 0.5rem; } removed, relies on gap */
      .right-nav-items {
          width: 100%;
          justify-content: space-between;
          margin-top: 10px;
      }
      .user-info {
          font-size: 0.8em;
      }
      nav .menu2 {
          padding: 0.4rem 0.8rem;
          font-size: 0.8em;
      }
  }
</style>
</head>
<body>

  <div id="header-placeholder"></div>

  <div class="main-content-wrapper">

    <div class="container" id="pageContainer">
      <h2>Download Absensi Mesin Fingerprint</h2>

      <!-- UI untuk peran 'user': Unggah JSON -->
      <div id="jsonFileUploadDiv" style="display: none;">
          <label>Pilih dan Upload File JSON Mesin:</label>
          <input type="file" id="jsonFile" accept=".json" onchange="window.handleFileUpload(event)"><br>
      </div>

      <!-- UI untuk peran 'admin'/'super_admin': Informasi muat dari Firestore -->
      <div id="firestoreLoadDiv" style="display: none;">
          <p>Data mesin dimuat dari Firebase Firestore secara otomatis.</p>
      </div>

      <label>Base URL:</label>
      <input type="text" id="base_url" value="http://10.30.32.16:5000/"><br>
      
      <!-- PERUBAHAN: Ganti <select> dengan <input type="text" dan <datalist> -->
      <label for="mesinInput">Pilih Mesin:</label>
      <input type="text" id="mesinInput" list="mesinDatalist" placeholder="Ketik atau pilih mesin">
      <datalist id="mesinDatalist"></datalist>
      <!-- BARU: Elemen untuk menampilkan IP Mesin -->
      <small id="selectedMachineIp" style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px;">IP Mesin: -</small>
      <br>

      <button class="green" id="downloadSatuMesinBtn" onclick="window.downloadSatuMesin()">⬇️ Download Mesin Terpilih</button>
      <button class="blue" id="downloadSemuaMesinBtn" onclick="window.downloadSemuaMesin()">⬇️ Download Semua Mesin</button>

      <div class="status-message" id="downloadStatusMessage"></div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

<script type="module">
    import { initPage } from "./common-ui.js";
    import { auth, db } from "./firebase-config.js";
    import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    let mesinList = {}; // Akan diisi dari JSON atau Firestore
    let currentUserRole = null; // Menyimpan peran pengguna

    const downloadStatusMessage = document.getElementById('downloadStatusMessage');
    const jsonFileUploadDiv = document.getElementById('jsonFileUploadDiv');
    const firestoreLoadDiv = document.getElementById('firestoreLoadDiv');
    const jsonFile = document.getElementById('jsonFile');
    const mesinInput = document.getElementById("mesinInput");
    const mesinDatalist = document.getElementById("mesinDatalist");
    // BARU: Referensi ke elemen IP Mesin
    const selectedMachineIpDisplay = document.getElementById('selectedMachineIp');

    const downloadSatuBtn = document.getElementById("downloadSatuMesinBtn");
    const downloadSemuaBtn = document.getElementById("downloadSemuaMesinBtn");

    document.addEventListener('DOMContentLoaded', () => {
        initPage("Download Data Finger", "pageContainer", "all_authenticated");
        
        auth.onAuthStateChanged(user => {
            if (user) {
                checkUserRoleAndLoadMachines();
            } else {
                setStatus(downloadStatusMessage, "Pengguna tidak terautentikasi. Silakan login.", 'error');
                jsonFileUploadDiv.style.display = 'none';
                firestoreLoadDiv.style.display = 'none';
                mesinInput.disabled = true;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
                downloadSatuBtn.disabled = true;
                downloadSemuaBtn.disabled = true;
            }
        });
    });

    function setStatus(messageElement, message, type = 'info') {
        messageElement.textContent = message;
        messageElement.className = `status-message ${type}`;
        setTimeout(() => {
            messageElement.className = 'status-message';
            messageElement.textContent = '';
        }, 5000);
    }

    window.openNewWindow = function(url) {
        window.open(url, '_blank', 'width=800,height=600');
    };

    async function checkUserRoleAndLoadMachines() {
        setStatus(downloadStatusMessage, "Mengecek peran pengguna...", 'info');
        try {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                setStatus(downloadStatusMessage, "Pengguna tidak terautentikasi.", 'error');
                return;
            }

            const userDocRef = doc(db, "users", currentUser.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists() && userDocSnap.data().role) {
                currentUserRole = userDocSnap.data().role;
                setStatus(downloadStatusMessage, `Peran pengguna terdeteksi: ${currentUserRole}`, 'info');

                if (currentUserRole === 'user') {
                    setupUserMachineLoading();
                } else if (currentUserRole === 'admin' || currentUserRole === 'super_admin') {
                    await loadMachinesFromFirestore();
                } else {
                    setStatus(downloadStatusMessage, "Peran pengguna tidak dikenal atau tidak berhak. Hubungi administrator.", 'error');
                    jsonFileUploadDiv.style.display = 'none';
                    firestoreLoadDiv.style.display = 'none';
                    mesinInput.disabled = true;
                    selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
                    downloadSatuBtn.disabled = true;
                    downloadSemuaBtn.disabled = true;
                }
            } else {
                setStatus(downloadStatusMessage, "Peran pengguna tidak ditemukan. Hubungi administrator.", 'error');
                jsonFileUploadDiv.style.display = 'none';
                firestoreLoadDiv.style.display = 'none';
                mesinInput.disabled = true;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
                downloadSatuBtn.disabled = true;
                downloadSemuaBtn.disabled = true;
            }
        } catch (e) {
            setStatus(downloadStatusMessage, `Gagal mendapatkan peran pengguna: ${e.message}`, 'error');
            console.error("Error getting user role:", e);
            jsonFileUploadDiv.style.display = 'none';
            firestoreLoadDiv.style.display = 'none';
            mesinInput.disabled = true;
            selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
            downloadSatuBtn.disabled = true;
            downloadSemuaBtn.disabled = true;
        }
    }

    function setupUserMachineLoading() {
        firestoreLoadDiv.style.display = 'none';
        jsonFileUploadDiv.style.display = 'block';
        setStatus(downloadStatusMessage, "Silakan unggah file JSON mesin Anda.", 'info');
        mesinInput.disabled = true;
        selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
        downloadSatuBtn.disabled = true;
        downloadSemuaBtn.disabled = true;
    }

    window.handleFileUpload = function(event) {
        const file = event.target.files[0];
        if (!file) {
            setStatus(downloadStatusMessage, "Tidak ada file yang dipilih.", 'info');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const uploadedData = JSON.parse(e.target.result);
                mesinList = uploadedData;
                isiDropdownMesin();
                setStatus(downloadStatusMessage, "Data mesin berhasil dimuat dari file JSON!", 'success');
                mesinInput.disabled = false;
                downloadSatuBtn.disabled = false;
                downloadSemuaBtn.disabled = false;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
            } catch (err) {
                setStatus(downloadStatusMessage, `JSON tidak valid: ${err.message}`, 'error');
                console.error("Error parsing JSON file:", err);
                mesinList = {};
                isiDropdownMesin();
                mesinInput.disabled = true;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
                downloadSatuBtn.disabled = true;
                downloadSemuaBtn.disabled = true;
            }
        };
        reader.readAsText(file);
    };

    async function loadMachinesFromFirestore() {
        jsonFileUploadDiv.style.display = 'none';
        firestoreLoadDiv.style.display = 'block';
        setStatus(downloadStatusMessage, "Memuat daftar mesin dari Firestore...", 'info');
        mesinList = {};

        try {
            const querySnapshot = await getDocs(collection(db, "mesin_fp"));
            if (querySnapshot.empty) {
                setStatus(downloadStatusMessage, "Tidak ada mesin ditemukan di Firestore.", 'info');
                mesinInput.disabled = true;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
                downloadSatuBtn.disabled = true;
                downloadSemuaBtn.disabled = true;
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    mesinList[data.mesin] = {
                        ip: data.ip,
                        port: data.port
                    };
                });
                isiDropdownMesin();
                setStatus(downloadStatusMessage, `Daftar mesin berhasil dimuat dari Firestore! (${Object.keys(mesinList).length} mesin)`, 'success');
                mesinInput.disabled = false;
                downloadSatuBtn.disabled = false;
                downloadSemuaBtn.disabled = false;
                selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
            }
        } catch (e) {
            setStatus(downloadStatusMessage, `Gagal memuat mesin dari Firestore: ${e.message}`, 'error');
            console.error("Gagal memuat mesin dari Firestore:", e);
            mesinList = {};
            isiDropdownMesin();
            mesinInput.disabled = true;
            selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display
            downloadSatuBtn.disabled = true;
            downloadSemuaBtn.disabled = true;
        }
    }

    // Fungsi untuk mengisi datalist
    window.isiDropdownMesin = function() {
        mesinDatalist.innerHTML = "";
        if (Object.keys(mesinList).length === 0) {
            mesinInput.placeholder = "-- Belum ada data --";
        } else {
            Object.keys(mesinList).forEach(m => {
                const opt = document.createElement("option");
                opt.value = m;
                mesinDatalist.appendChild(opt);
            });
            mesinInput.placeholder = "Ketik atau pilih mesin";
        }
        mesinInput.value = "";
        selectedMachineIpDisplay.textContent = "IP Mesin: -"; // BARU: reset IP display saat datalist diisi ulang
    };

    // BARU: Event listener untuk memperbarui tampilan IP saat input berubah
    mesinInput.addEventListener('input', () => {
        const selectedMesinName = mesinInput.value.trim();
        const machineData = mesinList[selectedMesinName];
        if (machineData && machineData.ip) {
            selectedMachineIpDisplay.textContent = `IP Mesin: ${machineData.ip}`;
        } else {
            selectedMachineIpDisplay.textContent = "IP Mesin: -";
        }
    });

    window.downloadSatuMesin = function() {
        const baseUrl = document.getElementById("base_url").value;
        const selectedMesinName = mesinInput.value.trim();

        if (!selectedMesinName) {
            setStatus(downloadStatusMessage, "Ketik atau pilih mesin dulu!", 'error');
            return;
        }
        
        if (!mesinList[selectedMesinName]) {
            setStatus(downloadStatusMessage, "Mesin yang Anda ketik tidak ditemukan dalam daftar.", 'error');
            return;
        }

        const machineData = mesinList[selectedMesinName];
        if (!machineData || !machineData.ip) {
            setStatus(downloadStatusMessage, `IP Address untuk mesin '${selectedMesinName}' tidak ditemukan.`, 'error');
            return;
        }
        const ipAddress = machineData.ip;

        if (!baseUrl) {
            setStatus(downloadStatusMessage, "Base URL harus diisi!", 'error');
            return;
        }
        setStatus(downloadStatusMessage, `Membuka tab baru untuk absensi mesin ${selectedMesinName} (${ipAddress})...`, 'info');
        let url = `${baseUrl}/lihat_absensi?mesin=${encodeURIComponent(ipAddress)}`;
        window.openNewWindow(url);
        setStatus(downloadStatusMessage, `Permintaan download untuk ${selectedMesinName} dikirim. Periksa tab baru di browser Anda.`, 'success');
    };

    window.downloadSemuaMesin = function() {
        const baseUrl = document.getElementById("base_url").value;
        if (Object.keys(mesinList).length === 0) {
            setStatus(downloadStatusMessage, "Belum ada data mesin yang dimuat untuk di-download!", 'error');
            return;
        }
        if (!baseUrl) {
            setStatus(downloadStatusMessage, "Base URL harus diisi!", 'error');
            return;
        }
        setStatus(downloadStatusMessage, "Membuka tab baru untuk setiap mesin yang akan di-download...", 'info');
        
        Object.values(mesinList).forEach(machineData => {
            let url = `${baseUrl}/lihat_absensi?mesin=${encodeURIComponent(machineData.ip)}`;
            window.openNewWindow(url);
        });
        setStatus(downloadStatusMessage, "Permintaan download semua absensi dikirim. Periksa tab baru di browser Anda.", 'success');
    };
</script>
</body>
</html>
