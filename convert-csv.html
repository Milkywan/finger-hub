<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Konversi Xls ‚Üí CSV/TXT</title>
  <!-- Sertakan library SheetJS di sini -->
  <script src="xlsx.full.min.js"></script> 
  <style>
    /* --- GLOBAL STYLES (Konsisten di semua halaman) --- */
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column; /* Menggunakan column untuk layout nav + content + footer */
      min-height: 100vh; /* Pastikan halaman memenuhi tinggi viewport */
    }
    
    /* --- NAVIGASI (Gaya yang sama seperti yang disuntikkan common-ui.js) --- */
    nav {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        z-index: 10;
    }
    nav .brand { font-weight: bold; font-size: 1.2rem; }
    nav .menu { 
        display: flex; 
        align-items: center;
        flex-grow: 1; 
        justify-content: center; 
    }
    nav .menu a {
        color: white; 
        text-decoration: none; 
        margin: 0 1rem; 
        transition: color .3s;
    }
    nav .menu a:hover, nav .menu a.active { color: #a5b4fc; }

    /* Gaya untuk info user dan tombol logout di header */
    .right-nav-items {
        display: flex;
        align-items: center;
        gap: 1rem; 
    }
    .user-info {
        font-size: 0.9rem; 
        color: rgba(255, 255, 255, 0.8);
        white-space: nowrap; 
    }
    nav .menu2 { /* Untuk tombol Logout */
        color: white;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: rgba(255,255,255,0.1);
        transition: background 0.3s, transform 0.2s;
        font-weight: bold;
    }
    nav .menu2:hover {
        background: rgba(255,255,255,0.2);
        transform: translateY(-2px);
    }

    /* --- WRAPPER KONTEN UTAMA --- */
    .main-content-wrapper {
        flex: 1; /* Ambil sisa ruang vertikal antara header dan footer */
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
    }

    /* --- GRID LAYOUT UNTUK DUA CARD --- */
    .converter-grid {
        display: flex; /* Menggunakan flexbox untuk layout horizontal */
        gap: 2rem; /* Jarak antar card */
        width: 100%;
        max-width: 1200px; /* Batasi lebar keseluruhan grid */
        justify-content: center; /* Pusatkan grid di tengah */
        flex-wrap: wrap; /* Izinkan wrapping pada layar kecil */
    }

    /* --- CONTAINER UTAMA / CARD (Konsisten di semua halaman admin) --- */
    .container { 
        background: rgba(255,255,255,0.1); /* Latar belakang transparan */
        padding: 2rem; /* Padding lebih besar */
        border-radius: 1rem; /* Border radius lebih besar */
        width: 100%; /* Default 100% untuk mobile */
        max-width: 550px; /* Batasi lebar card tunggal */
        box-shadow: 0 8px 24px rgba(0,0,0,0.3); /* Shadow baru */
        backdrop-filter: blur(8px); /* Efek blur */
        animation: fadeIn .8s ease; /* Animasi fade in */
        flex: 1; /* Biarkan flexbox mengatur lebar */
        min-width: 300px; /* Lebar minimum sebelum wrap */
    }
    @keyframes fadeIn { /* Animasi fade in */
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h1, h2 { margin-top: 0; text-align: center; }
    textarea {
      width: 100%; height: 200px;
      border: none; border-radius: 0.5rem;
      padding: 1rem; margin-top: 1rem;
      font-family: monospace; resize: vertical; /* Allow vertical resize */
      background: rgba(255,255,255,0.25); color: white;
    }
    input::placeholder,
    textarea::placeholder { /* Menargetkan placeholder pada input dan textarea */
    color: #cccccc; /* Contoh: warna abu-abu terang */
    /* Atau rgba(255,255,255,0.8) jika ingin lebih terang dari default tapi tetap semi-transparan */
    }
    .options { text-align: center; margin-top: 1rem; }
    .options label { margin: 0 1rem; font-size: .95rem; }
    button, .upload-label {
      padding: 0.75rem 1.25rem; border: none; border-radius: 0.5rem;
      cursor: pointer; font-weight: bold; margin: .5rem .25rem;
      transition: background .3s, transform .2s, box-shadow .2s;
    }
    button.primary { background: #10b981; color: #fff; }
    .upload-label { background: #3b82f6; color: #fff; display: inline-block; }
    button:hover, .upload-label:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }

    .progress-container {
      margin-top: 1rem; background: rgba(255,255,255,0.2);
      border-radius: 0.5rem; overflow: hidden;
      height: 16px; display: none;
    }
    .progress-bar {
      height: 100%; width: 0%; background: #10b981; transition: width 0.3s ease;
    }
    /* Status Message (Consistent with superadmin_settings.html) */
    .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        text-align: center;
        display: none; /* Defaultnya tersembunyi */
    }
    .status-message.success { background-color: #10b981; color: white; display: block; }
    .status-message.error { background-color: #ef4444; color: white; display: block; }
    .status-message.info { background-color: #60a5fa; color: white; display: block; }

    /* --- FOOTER (Gaya yang sama seperti yang disuntikkan common-ui.js) --- */
    footer {
      text-align: center;
      padding: 1rem;
      font-size: .9rem;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
    }
    footer a { color: white; text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* --- Media Queries for Responsiveness (Konsisten di semua halaman) --- */
    @media (max-width: 768px) {
        nav { 
            padding: 1rem; 
            flex-direction: column; 
            align-items: flex-start; 
        }
        nav .brand { margin-bottom: 10px; } 
        nav .menu { 
            width: 100%; 
            flex-wrap: wrap; 
            justify-content: flex-start; 
            margin-bottom: 10px;
        }
        nav .menu a { margin: 0.5rem 0.5rem; } 
        .right-nav-items {
            width: 100%; 
            justify-content: space-between; 
            margin-top: 10px;
        }
        .converter-grid {
            flex-direction: column; /* Tumpuk card secara vertikal pada layar kecil */
            align-items: center; /* Pusatkan card saat ditumpuk */
        }
    }
    @media (max-width: 600px) { .container { padding: 1rem; } }
    .drop-hover { outline: 2px dashed #a5b4fc; background: rgba(255,255,255,0.2); }
  </style>
</head>
<body>
  <!-- Placeholder untuk Header yang akan disuntikkan oleh common-ui.js -->
  <div id="header-placeholder"></div> 

  <!-- Wrapper untuk konten utama, agar layout vertikal rapi -->
  <div class="main-content-wrapper">
    <!-- Grid utama untuk dua card converter -->
    <div class="converter-grid">

        <!-- Card 1: Konversi Data Absensi Mentah (Log-like) -->
        <div class="container" id="rawConverterContainer">
            <h2>Konversi Absensi (Log Mentah)</h2>
            <p style="text-align:center;">Tempel data absensi dari log mesin atau upload file:</p>
            <input type="file" id="rawFileInput" accept=".txt" style="display:none;" />
            <div style="text-align:center;">
              <label for="rawFileInput" class="upload-label">üìÇ Upload File Teks</label>
            </div>
            <textarea id="rawInputData" placeholder="User ID: F0222000445, Nama: IrwanS, Waktu: 2025-05-22 06:50:44, Status: 1"></textarea>
            <div class="options">
              <label><input type="radio" name="rawMode" value="csv" checked> CSV (Excel)</label>
              <label><input type="radio" name="rawMode" value="txt"> TXT (Notepad)</label>
            </div>
            <div style="text-align:center;">
              <button class="primary" onclick="window.convertRawAndDownload()">‚öôÔ∏è Konversi & Download</button>
            </div>
            <div class="progress-container" id="rawProgressContainer"><div class="progress-bar" id="rawProgressBar"></div></div>
            <div class="status-message" id="rawProgressStatus"></div>
        </div>

        <!-- Card 2: Konversi Data Absensi Tabel (CSV/Excel) -->
        <div class="container" id="structuredConverterContainer">
            <h2>Konversi Absensi (Tabel/CSV/Excel)</h2>
            <p style="text-align:center;">Tempel data tabel (dari Excel/CSV) atau <strong style="color: #a5b4fc;">upload file CSV/TXT/XLSX</strong>:</p>
            <!-- Update accept attribute to include .xlsx -->
            <input type="file" id="structuredFileInput" accept=".txt,.csv,.xlsx" style="display:none;" />
            <div style="text-align:center;">
              <label for="structuredFileInput" class="upload-label">üìÇ Upload File CSV/TXT/XLSX</label>
            </div>
            <textarea id="structuredInputData" placeholder="No. ID	NIK	Nama	Waktu	Status&#10;F0222000445	F0222000445	IrwanS	10/09/2025 06:45	C/Masuk"></textarea>
            <div class="options">
              <label><input type="radio" name="structuredMode" value="csv" checked> CSV (Excel)</label>
              <label><input type="radio" name="structuredMode" value="txt"> TXT (Notepad)</label>
            </div>
            <div style="text-align:center;">
              <button class="primary" onclick="window.convertStructuredAndDownload()">‚öôÔ∏è Konversi & Download</button>
            </div>
            <div class="progress-container" id="structuredProgressContainer"><div class="progress-bar" id="structuredProgressBar"></div></div>
            <div class="status-message" id="structuredProgressStatus"></div>
        </div>

    </div>
  </div>

  <!-- Placeholder untuk Footer yang akan disuntikkan oleh common-ui.js -->
  <div id="footer-placeholder"></div> 

<script type="module">
    // Import initPage dari common-ui.js
    import { initPage } from "./common-ui.js";

    // Panggil initPage saat DOM siap
    document.addEventListener('DOMContentLoaded', () => {
      initPage(
          "Converter Xls",     // pageTitle (akan jadi active di navigasi)
          "rawConverterContainer", // mainContentId (ID dari div container utama halaman ini, bisa salah satu)
          "user"                   // requiredRole (semua user bisa akses)
      );
    });

    // --- Helper Functions (Shared) ---
    function setStatus(messageElement, message, type = 'info', timeout = 5000) {
        messageElement.textContent = message;
        messageElement.className = `status-message ${type}`;
        if (timeout > 0) {
            setTimeout(() => {
                messageElement.className = 'status-message'; // Reset class untuk menyembunyikan
                messageElement.textContent = '';
            }, timeout);
        }
    }

    // --- CARD 1: RAW CONVERTER FUNCTIONS ---
    const rawInputData = document.getElementById('rawInputData');
    const rawFileInput = document.getElementById('rawFileInput');
    const rawProgressContainer = document.getElementById('rawProgressContainer');
    const rawProgressBar = document.getElementById('rawProgressBar');
    const rawProgressStatus = document.getElementById('rawProgressStatus');

    const rawStatusMap = { "1": "C/Masuk", "2": "C/Keluar", "3": "Lembur Masuk", "4": "Lembur Keluar" };

    // Generic file handling for text-based files (for raw converter)
    function handleRawFile(file) {
        if (!file) {
            setStatus(rawProgressStatus, 'Tidak ada file yang dipilih.', 'info');
            return;
        }
        const reader = new FileReader();
        reader.onprogress = evt => {
            if (evt.lengthComputable) {
                const percent = Math.round((evt.loaded / evt.total) * 100);
                updateCardProgress(rawProgressContainer, rawProgressBar, rawProgressStatus, percent, 'Membaca file');
            }
        };
        reader.onloadstart = () => updateCardProgress(rawProgressContainer, rawProgressBar, rawProgressStatus, 0, 'Membaca file');
        reader.onload = evt => {
            rawInputData.value = evt.target.result;
            updateCardProgress(rawProgressContainer, rawProgressBar, rawProgressStatus, 100, 'File berhasil dibaca ‚úîÔ∏è');
            setTimeout(() => {
                rawProgressContainer.style.display = 'none';
                rawProgressStatus.style.display = 'none';
            }, 1000);
            setStatus(rawProgressStatus, 'File berhasil dibaca!', 'success');
        };
        reader.readAsText(file);
    }

    rawFileInput.addEventListener('change', e => handleRawFile(e.target.files[0]));
    rawInputData.addEventListener('dragover', e => { e.preventDefault(); rawInputData.classList.add('drop-hover'); });
    rawInputData.addEventListener('dragleave', e => { rawInputData.classList.remove('drop-hover'); });
    rawInputData.addEventListener('drop', e => {
      e.preventDefault(); rawInputData.classList.remove('drop-hover');
      handleRawFile(e.dataTransfer.files[0]);
    });

    window.convertRawAndDownload = function() {
      const rawText = rawInputData.value.trim();
      if (!rawText) { 
        setStatus(rawProgressStatus, 'Tempel atau upload data dulu ya.', 'error');
        return;
      }

      setStatus(rawProgressStatus, 'Memulai konversi...', 'info', 0); // Keep status until done

      setTimeout(() => {
        setStatus(rawProgressStatus, 'Memproses data...');
        const lines = rawText.split('\n');
        let outputContent = ['NIK,NAMA,Waktu,Status']; // Header awal

        lines.forEach(line => {
          const nik = (line.match(/User ID:\s*([^,]+)/) || [])[1]?.trim() || "";
          const nama = (line.match(/Nama:\s*(.+?),\s*Waktu:/) || [])[1]?.trim() || "";
          let waktu = (line.match(/Waktu:\s*([^,]+)/) || [])[1]?.trim() || "";
          let status = (line.match(/Status:\s*(\d+)/) || [])[1]?.trim() || "";

          // Convert YYYY-MM-DD HH:MM:SS to DD/MM/YYYY HH:MM
          if (waktu.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
            const [datePart, timePart] = waktu.split(' ');
            const [y, m, d] = datePart.split('-');
            const [hh, mm] = timePart.split(':'); // ignore seconds
            waktu = `${d}/${m}/${y} ${hh}:${mm}`;
          }
          status = rawStatusMap[status] || "C/Masuk"; // Default if not found

          // Basic CSV quoting for name if it contains commas
          const quotedNama = nama.includes(',') ? `"${nama.replace(/"/g, '""')}"` : nama;
          outputContent.push(`${nik},${quotedNama},${waktu},${status}`);
        });

        setTimeout(() => {
          setStatus(rawProgressStatus, 'Menyiapkan file...');
          const mode = document.querySelector('input[name="rawMode"]:checked').value;
          const type = (mode === 'csv') ? 'text/csv' : 'text/plain';
          const ext = (mode === 'csv') ? 'csv' : 'txt';
          const finalOutput = outputContent.join('\n');

          setTimeout(() => {
            const blob = new Blob([finalOutput], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `data_absensi_mentah_konversi.${ext}`;
            a.click();
            URL.revokeObjectURL(url);

            setStatus(rawProgressStatus, `Konversi selesai! File data_absensi_mentah_konversi.${ext} berhasil diunduh.`, 'success');
          }, 500);
        }, 500);
      }, 500);
    };

    // --- CARD 2: STRUCTURED CONVERTER FUNCTIONS ---
    const structuredInputData = document.getElementById('structuredInputData');
    const structuredFileInput = document.getElementById('structuredFileInput');
    const structuredProgressContainer = document.getElementById('structuredProgressContainer');
    const structuredProgressBar = document.getElementById('structuredProgressBar');
    const structuredProgressStatus = document.getElementById('structuredProgressStatus');

    // Helper to update progress specific to this card
    function updateCardProgress(container, bar, statusEl, percent, text) {
        container.style.display = 'block';
        statusEl.style.display = 'block';
        bar.style.width = percent + '%';
        statusEl.textContent = text + ` (${percent}%)`;
    }

    // New handler for structured files, including XLSX
    function handleStructuredFile(file) {
        if (!file) {
            setStatus(structuredProgressStatus, 'Tidak ada file yang dipilih.', 'info');
            return;
        }

        const fileName = file.name.toLowerCase();
        const reader = new FileReader();

        reader.onprogress = evt => {
            if (evt.lengthComputable) {
                const percent = Math.round((evt.loaded / evt.total) * 100);
                updateCardProgress(structuredProgressContainer, structuredProgressBar, structuredProgressStatus, percent, 'Membaca file');
            }
        };
        reader.onloadstart = () => updateCardProgress(structuredProgressContainer, structuredProgressBar, structuredProgressStatus, 0, 'Membaca file');

        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            reader.onload = evt => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to CSV string, which our existing logic can then parse
                    const csvData = XLSX.utils.sheet_to_csv(worksheet);
                    structuredInputData.value = csvData;

                    updateCardProgress(structuredProgressContainer, structuredProgressBar, structuredProgressStatus, 100, 'File Excel berhasil dibaca ‚úîÔ∏è');
                    setTimeout(() => {
                        structuredProgressContainer.style.display = 'none';
                        structuredProgressStatus.style.display = 'none';
                    }, 1000);
                    setStatus(structuredProgressStatus, `File Excel (${firstSheetName}) berhasil dibaca!`, 'success');

                } catch (e) {
                    updateCardProgress(structuredProgressContainer, structuredProgressBar, structuredProgressStatus, 100, 'Gagal membaca file Excel');
                    setStatus(structuredProgressStatus, `Error membaca file Excel: ${e.message}`, 'error');
                    console.error("Error reading XLSX:", e);
                    structuredProgressContainer.style.display = 'none';
                    structuredProgressStatus.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file); // Read XLSX as ArrayBuffer
        } else { // .csv or .txt files
            reader.onload = evt => {
                structuredInputData.value = evt.target.result;
                updateCardProgress(structuredProgressContainer, structuredProgressBar, structuredProgressStatus, 100, 'File berhasil dibaca ‚úîÔ∏è');
                setTimeout(() => {
                    structuredProgressContainer.style.display = 'none';
                    structuredProgressStatus.style.display = 'none';
                }, 1000);
                setStatus(structuredProgressStatus, 'File berhasil dibaca!', 'success');
            };
            reader.readAsText(file); // Read CSV/TXT as text
        }
    }

    structuredFileInput.addEventListener('change', e => handleStructuredFile(e.target.files[0]));
    structuredInputData.addEventListener('dragover', e => { e.preventDefault(); structuredInputData.classList.add('drop-hover'); });
    structuredInputData.addEventListener('dragleave', e => { structuredInputData.classList.remove('drop-hover'); });
    structuredInputData.addEventListener('drop', e => {
      e.preventDefault(); structuredInputData.classList.remove('drop-hover');
      handleStructuredFile(e.dataTransfer.files[0]);
    });

    // Fungsi untuk mendeteksi delimiter input (tab atau koma)
    function detectDelimiter(line) {
        const commaCount = (line.match(/,/g) || []).length;
        const tabCount = (line.match(/\t/g) || []).length;
        if (tabCount > 0 && tabCount >= commaCount) {
            return '\t';
        }
        return ','; // Default ke koma jika tidak ada tab atau tab lebih sedikit
    }

    // Helper function to parse a line based on delimiter (handles simple CSV/TSV)
    function parseCsvOrTabLine(line, delimiter) {
        if (delimiter === ',') {
            const cells = [];
            let inQuote = false;
            let currentCell = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (i + 1 < line.length && line[i+1] === '"') { 
                        currentCell += '"';
                        i++; // Skip the next quote
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    cells.push(currentCell.trim());
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            cells.push(currentCell.trim()); 
            return cells;
        } else { // Assume tab-separated
            return line.split(delimiter).map(cell => cell.trim());
        }
    }

    window.convertStructuredAndDownload = function() {
      const rawText = structuredInputData.value.trim();
      if (!rawText) { 
        setStatus(structuredProgressStatus, 'Tempel atau upload data dulu ya.', 'error');
        return;
      }

      setStatus(structuredProgressStatus, 'Memulai konversi...', 'info', 0); // Keep status until done

      setTimeout(() => {
          setStatus(structuredProgressStatus, 'Memproses data baris demi baris...');
          const lines = rawText.split('\n').filter(line => line.trim() !== '');
          if (lines.length === 0) {
              setStatus(structuredProgressStatus, 'Data tidak ditemukan.', 'error');
              return;
          }

          const inputDelimiter = detectDelimiter(lines[0]);
          const outputMode = document.querySelector('input[name="structuredMode"]:checked').value;
          const outputDelimiter = (outputMode === 'csv') ? ',' : '\t'; // Tab for TXT

          let outputContent = [];
          let header = parseCsvOrTabLine(lines[0], inputDelimiter).map(h => h.trim());

          outputContent.push(header.map(h => {
              return (outputMode === 'csv' && (h.includes(',') || h.includes('"'))) ? `"${h.replace(/"/g, '""')}"` : h;
          }).join(outputDelimiter));

          const waktuColIndex = header.findIndex(h => h.toLowerCase() === 'waktu');
          const namaColIndex = header.findIndex(h => h.toLowerCase() === 'nama');

          if (waktuColIndex === -1) {
              setStatus(structuredProgressStatus, 'Kolom "Waktu" tidak ditemukan di data Anda. Pastikan ada header "Waktu".', 'error');
              return;
          }

          for (let i = 1; i < lines.length; i++) {
              const cells = parseCsvOrTabLine(lines[i], inputDelimiter);
              if (cells.length === 0) continue;

              while (cells.length <= Math.max(waktuColIndex, namaColIndex)) {
                  cells.push('');
              }

              let waktuCell = cells[waktuColIndex];
              if (waktuCell) {
                 const match = waktuCell.match(/^(\d{2})[/\-](\d{2})[/\-](\d{4}) (\d{2}:\d{2})$/);
                 if (match) {
                     waktuCell = `${match[1]}-${match[2]}-${match[3]} ${match[4]}`;
                 }
              }
              cells[waktuColIndex] = waktuCell;

              let namaCell = cells[namaColIndex];
              if (namaColIndex !== -1 && outputMode === 'csv') {
                  if (namaCell.includes(',') || namaCell.includes('"')) {
                      namaCell = `"${namaCell.replace(/"/g, '""')}"`;
                  }
              }
              cells[namaColIndex] = namaCell;

              outputContent.push(cells.join(outputDelimiter));
          }

          setTimeout(() => {
              setStatus(structuredProgressStatus, 'Menyiapkan file untuk diunduh...');
              const type = (outputMode === 'csv') ? 'text/csv' : 'text/plain';
              const ext = (outputMode === 'csv') ? 'csv' : 'txt';
              const finalOutput = outputContent.join('\n');

              setTimeout(() => {
                  const blob = new Blob([finalOutput], { type });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `data_absensi_tabel_konversi.${ext}`;
                  a.click();
                  URL.revokeObjectURL(url);

                  setStatus(structuredProgressStatus, `Konversi selesai! File data_absensi_tabel_konversi.${ext} berhasil diunduh.`, 'success');
              }, 500);
          }, 500);
      }, 500);
    };
</script>
</body>
</html>





