<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Download Absensi Mesin</title>
<style>
  /* --- GLOBAL STYLES (Konsisten di semua halaman) --- */
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #4f46e5, #9333ea);
    color: white;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column; /* Menggunakan column untuk layout nav + content + footer */
    min-height: 100vh; /* Pastikan halaman memenuhi tinggi viewport */
  }
  
  /* --- NAVIGASI (Gaya yang sama seperti yang disuntikkan common-ui.js) --- */
  nav {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      z-index: 10;
  }
  nav .brand { font-weight: bold; font-size: 1.2rem; }
  nav .menu { 
      display: flex; 
      align-items: center;
      flex-grow: 1; 
      justify-content: center; 
  }
  nav .menu a {
      color: white; 
      text-decoration: none; 
      margin: 0 1rem; 
      transition: color .3s;
  }
  nav .menu a:hover, nav .menu a.active { color: #a5b4fc; }

  /* Gaya untuk info user dan tombol logout di header */
  .right-nav-items {
      display: flex;
      align-items: center;
      gap: 1rem; 
  }
  .user-info {
      font-size: 0.9rem; 
      color: rgba(255, 255, 255, 0.8);
      white-space: nowrap; 
  }
  nav .menu2 { /* Untuk tombol Logout */
      color: white;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: rgba(255,255,255,0.1);
      transition: background 0.3s, transform 0.2s;
      font-weight: bold;
  }
  nav .menu2:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
  }

  /* --- WRAPPER KONTEN UTAMA --- */
  .main-content-wrapper {
    flex: 1; /* Ambil sisa ruang vertikal antara header dan footer */
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
  }

  /* --- CARD KONTEN SPESIFIK HALAMAN INI --- */
  /* Nama class 'card' diubah menjadi 'container' untuk konsistensi dengan pola admin pages */
  .container { /* Menggantikan .card di HTML asli */
    background: rgba(255,255,255,0.1);
    padding: 2rem;
    border-radius: 1rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    backdrop-filter: blur(8px);
    animation: fadeIn .8s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  /* --- HEADINGS --- */
  h2 { text-align: center; margin-top: 0; }

  /* --- INPUTS & SELECTS --- */
  input, select {
    width: 100%; padding: .75rem; margin-top: .5rem; /* Menyesuaikan padding & margin */
    border-radius: .5rem; border: none; /* Menyesuaikan border-radius */
    background: rgba(255,255,255,0.15); 
    color: white; /* Mengubah warna teks input agar terlihat di latar belakang gelap */
  }
  input::placeholder {
      color: rgba(255,255,255,0.6); /* Placeholder warna putih */
  }
  select option { /* Gaya untuk opsi dropdown agar terlihat di background gelap */
      background: #4f46e5;
      color: white;
  }
  input[type="file"] { background: none; color: white; } /* Menyesuaikan warna teks input file */

  /* --- BUTTONS --- */
  button {
    width: 100%; padding: .75rem; margin-top: .75rem; /* Menyesuaikan padding & margin */
    border: none; border-radius: .5rem; /* Menyesuaikan border-radius */
    font-weight: bold; cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }
  button.green { background: #10b981; color: white; }
  button.blue { background: #3b82f6; color: white; }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }

  /* --- STATUS MESSAGE (Ditambahkan, konsisten dengan superadmin_settings.html) --- */
  .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
      display: none; /* Defaultnya tersembunyi */
  }
  .status-message.success { background-color: #10b981; color: white; display: block; }
  .status-message.error { background-color: #ef4444; color: white; display: block; }
  .status-message.info { background-color: #60a5fa; color: white; display: block; }

  /* --- FOOTER (Gaya yang sama seperti yang disuntikkan common-ui.js) --- */
  footer { 
      text-align: center; 
      padding: 1rem; 
      font-size: .9rem;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
  }
  footer a { color: white; text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  /* --- Media Queries for Responsiveness (Konsisten di semua halaman) --- */
  @media (max-width: 768px) {
      nav { 
          padding: 1rem; 
          flex-direction: column; 
          align-items: flex-start; 
      }
      nav .brand { margin-bottom: 10px; } 
      nav .menu { 
          width: 100%; 
          flex-wrap: wrap; 
          justify-content: flex-start; 
          margin-bottom: 10px;
      }
      nav .menu a { margin: 0.5rem 0.5rem; } 
      .right-nav-items {
          width: 100%; 
          justify-content: space-between; 
          margin-top: 10px;
      }
  }
</style>
</head>
<body>
  <!-- Placeholder untuk Header yang akan disuntikkan oleh common-ui.js -->
  <div id="header-placeholder"></div> 

  <!-- Wrapper untuk konten utama, agar layout vertikal rapi -->
  <div class="main-content-wrapper">
    <!-- Konten halaman spesifik (sekarang menggunakan id "pageContainer" dan class "container") -->
    <div class="container" id="pageContainer">
      <h2>Download Absensi Mesin Fingerprint</h2>
      <label>Pilih dan Upload File JSON Mesin :</label>
      <input type="file" id="jsonFile" accept=".json" onchange="window.handleFileUpload(event)"><br>
      <label>Base URL:</label>
      <input type="text" id="base_url" value="http://10.30.32.16:5000/"><br>
      <label>Pilih Mesin:</label>
      <select id="mesin"><option value="">-- Belum ada data --</option></select><br>

      <button class="green" onclick="window.downloadSatuMesin()">⬇️ Download Mesin Terpilih</button>
      <button class="blue" onclick="window.downloadSemuaMesin()">⬇️ Download Semua Mesin</button>

      <!-- Elemen untuk menampilkan pesan status -->
      <div class="status-message" id="downloadStatusMessage"></div>
    </div>
  </div>

  <!-- Placeholder untuk Footer yang akan disuntikkan oleh common-ui.js -->
  <div id="footer-placeholder"></div> 

<script type="module">
    // Import initPage dari common-ui.js
    import { initPage } from "./common-ui.js";

    let mesinList = {};

    // --- Elemen DOM ---
    const downloadStatusMessage = document.getElementById('downloadStatusMessage'); // Elemen pesan status

    // Panggil initPage saat DOM siap
    document.addEventListener('DOMContentLoaded', () => {
      initPage(
          "Download Data Finger", // pageTitle (akan jadi active di navigasi, jika ada)
          "pageContainer",          // mainContentId (ID dari div container utama halaman ini)
          "user"                    // requiredRole (semua user bisa akses, disesuaikan jika perlu)
      );
      window.loadMachinesDefault(); // Panggil fungsi ini setelah initPage()
    });

    // --- Fungsi Helper Umum ---
    function setStatus(messageElement, message, type = 'info') {
        messageElement.textContent = message;
        messageElement.className = `status-message ${type}`;
        // Opsional: Sembunyikan pesan setelah beberapa detik
        setTimeout(() => {
            messageElement.className = 'status-message'; // Mengatur ulang class untuk menyembunyikan
            messageElement.textContent = '';
        }, 5000); // Pesan akan hilang setelah 5 detik
    }

    window.openNewWindow = function(url) {
      window.open(url, '_blank', 'width=800,height=600'); // Membuka dengan dimensi yang ditentukan
    };

    window.handleFileUpload = function(event) {
      const file = event.target.files[0];
      if (!file) {
          setStatus(downloadStatusMessage, "Tidak ada file yang dipilih.", 'info');
          return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          mesinList = JSON.parse(e.target.result);
          window.isiDropdownMesin();
          setStatus(downloadStatusMessage, "Data mesin berhasil dimuat dari file JSON!", 'success');
        } catch (err) {
          setStatus(downloadStatusMessage, `JSON tidak valid: ${err.message}`, 'error');
          console.error("Error parsing JSON file:", err);
        }
      };
      reader.readAsText(file);
    };

    window.loadMachinesDefault = async function() {
      setStatus(downloadStatusMessage, "Memuat daftar mesin default...", 'info');
      try {
        const resp = await fetch('mesin.json');
        if (!resp.ok) { // Check if response was successful
             throw new Error(`HTTP error! status: ${resp.status}`);
        }
        mesinList = await resp.json();
        window.isiDropdownMesin();
        setStatus(downloadStatusMessage, `Daftar mesin default berhasil dimuat! (${Object.keys(mesinList).length} mesin)`, 'success');
      } catch (e) {
        setStatus(downloadStatusMessage, "Gagal memuat mesin.json (normal jika file tidak ada atau tanpa server Flask/lokal). Gunakan upload JSON.", 'info');
        console.warn("Gagal memuat mesin.json:", e);
        mesinList = {}; // Pastikan kosong jika gagal load
        window.isiDropdownMesin(); // Kosongkan dropdown
      }
    };

    window.isiDropdownMesin = function() {
      const mesinSelect = document.getElementById("mesin");
      mesinSelect.innerHTML = "";
      Object.keys(mesinList).forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        mesinSelect.appendChild(opt);
      });
      if (Object.keys(mesinList).length === 0) {
        let opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- Belum ada data --";
        mesinSelect.appendChild(opt);
      }
    };

    window.downloadSatuMesin = function() {
      const baseUrl = document.getElementById("base_url").value;
      const mesin = document.getElementById("mesin").value;
      if (!mesin) {
          setStatus(downloadStatusMessage, "Pilih mesin dulu!", 'error');
          return;
      }
      if (!baseUrl) {
          setStatus(downloadStatusMessage, "Base URL harus diisi!", 'error');
          return;
      }
      setStatus(downloadStatusMessage, `Membuka tab baru untuk absensi mesin ${mesin}...`, 'info');
      let url = `${baseUrl}/lihat_absensi?mesin=${mesin}`;
      window.openNewWindow(url);
      setStatus(downloadStatusMessage, `Permintaan download untuk ${mesin} dikirim. Periksa tab baru di browser Anda.`, 'success');
    };

    window.downloadSemuaMesin = function() {
      const baseUrl = document.getElementById("base_url").value;
      if (!Object.keys(mesinList).length) {
          setStatus(downloadStatusMessage, "Belum ada data mesin yang dimuat untuk di-download!", 'error');
          return;
      }
      if (!baseUrl) {
          setStatus(downloadStatusMessage, "Base URL harus diisi!", 'error');
          return;
      }
      setStatus(downloadStatusMessage, "Membuka tab baru untuk setiap mesin yang akan di-download...", 'info');
      Object.keys(mesinList).forEach(m => {
        let url = `${baseUrl}/lihat_absensi?mesin=${m}`;
        window.openNewWindow(url);
      });
      setStatus(downloadStatusMessage, "Permintaan download semua absensi dikirim. Periksa tab baru di browser Anda.", 'success');
    };
  </script>
</body>
</html>
