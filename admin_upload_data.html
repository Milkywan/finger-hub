<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" type="image/png" href="images/icon.png">

    <title>Kelola Data Karyawan</title>

    <script src="./xlsx.full.min.js"></script>

    <style>
        /* --- General & Body Styles --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Navigation Styles (Diadaptasi dari skrip pertama untuk konsep menu ikon) --- */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            z-index: 10;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        nav .brand {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }
        nav .menu {
            display: flex;
            align-items: center;
            flex-grow: 1;
            justify-content: center;
            gap: 8px;
        }
        .menu-icon-link {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            text-decoration: none;
            color: white;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .menu-icon-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #a5b4fc;
        }
        .menu-icon-link .menu-icon {
            width: 33px;
            height: 33px;
            object-fit: contain;
        }
        .menu-icon-link .menu-text {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 1000;
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%) translateY(5px);
        }
        .menu-icon-link:hover .menu-text {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .menu-icon-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #a5b4fc;
        }
        .right-nav-items {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }
        nav .menu2 {
            color: white;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(255,255,255,0.1);
            transition: background 0.3s, transform 0.2s;
            font-weight: bold;
            font-size: 0.9em;
        }
        nav .menu2:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        /* --- Main Content Layout --- */
        .main-content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding: 2rem;
        }
        .container {
            background: rgba(255,255,255,0.06); /* Lebih transparan */
            padding: 1.25rem; /* Sedikit lebih kecil */
            border-radius: 12px; /* Lebih halus */
            width: 100%;
            max-width: 1100px; /* Lebih lebar */
            box-shadow: 0 10px 30px rgba(0,0,0,0.35); /* Lebih tegas */
            backdrop-filter: blur(6px); /* Blur lebih sedikit */
        }
        h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 26px;
        }

        /* --- Controls & Buttons --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Jarak antar item */
            margin-bottom: 20px;
            align-items: center;
            justify-content: flex-start; /* Sejajarkan ke kiri */
        }
        .btn {
            padding: 8px 12px; /* Lebih kecil */
            border: none;
            border-radius: 8px; /* Lebih halus */
            font-weight: 600; /* Lebih tebal */
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            font-size: 14px;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-primary { background: #4f46e5; color: #fff; }
        .btn-primary:hover { background: #4338ca; }
        .btn-secondary { background: #f59e0b; color: #fff; }
        .btn-secondary:hover { background: #d97706; }
        .btn-info { background: #3b82f6; color: #fff; }
        .btn-info:hover { background: #2563eb; }
        .btn-ghost {
            background: rgba(255,255,255,0.06);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        /* --- Form Input (for Modal and Search) --- */
        input[type="file"] {
            display: none; /* Sembunyikan input file asli */
        }
        .file-input-label { /* Label kustom untuk input file */
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, transform 0.2s;
            font-size: 14px;
        }
        .file-input-label:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        #searchInput {
            flex-grow: 1; /* Agar search input bisa mengisi ruang */
            min-width: 200px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            color: white;
            font-size: 14px;
        }
        #searchInput::placeholder {
            color: rgba(255,255,255,0.6);
        }
        #searchInput:focus {
            outline: none;
            border-color: #a5b4fc;
            box-shadow: 0 0 0 2px rgba(165, 180, 252, 0.3);
        }

        /* --- Status Message --- */
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            /* Default display: block; jika ingin selalu terlihat. Jika tidak, controlled by JS. */
        }
        .status-message.success { background-color: #10b981; color: white; }
        .status-message.error { background-color: #ef4444; color: white; }
        .status-message.info { background-color: #60a5fa; color: white; }

        /* --- Table Styles --- */
        .table-wrap {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            max-height: 520px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    overflow-x: auto; /* Ini memungkinkan gulir horizontal */
    overflow-y: auto;
        }
.sticky-col-1 { /* Kolom Checkbox */
    position: sticky;
    left: 0;
    z-index: 3; /* Lebih tinggi dari header non-sticky, dan juga sticky-col-2 */
    background: rgba(255,255,255,0.15); /* Beri background agar tidak transparan */
}

.sticky-col-2 { /* Kolom No */
    position: sticky;
    left: 30px; /* Lebar kolom checkbox (30px) */
    z-index: 2; /* Lebih rendah dari sticky-col-1, tapi masih di atas konten */
    background: rgba(255,255,255,0.15); /* Beri background agar tidak transparan */
}
        table {
            width: 100%;
            border-collapse: collapse;
            color: white;
            min-width: 1300px; /* Minimal width for the table with many columns */
        }
        th, td {
            border: 1px solid rgba(255,255,255,0.15); /* Border lebih halus */
            padding: 10px 12px; /* Padding lebih banyak */
            text-align: left;
            font-size: 13px;
        }
        th {
            background: rgba(255,255,255,0.1); /* Background header */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 2; /* Pastikan header sticky di atas konten lain saat scroll */
        }

        tbody tr:nth-child(odd) { background: rgba(255, 255, 255, 0.04); }
        tbody tr:hover { background: rgba(255, 255, 255, 0.08); }

        .icon-btn {
            background:transparent;
            border:1px solid rgba(255,255,255,0.06);
            padding:6px 8px;
            border-radius:6px;
            cursor:pointer;
            color:white;
            font-size: 12px;
            margin-right: 4px; /* Untuk jarak antar tombol */
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- Table specific styling --- */
        .muted { color: rgba(255,255,255,0.7); font-size:13px; }
        .updated-row {
            background-color: rgba(255, 255, 0, 0.08); /* A subtle yellow tint */
        }
        .updated-row:hover {
            background-color: rgba(255, 255, 0, 0.15); /* Slightly darker on hover */
        }
        .duplicate-entry {
            background-color: rgba(255, 0, 0, 0.15); /* A subtle red tint for duplicates */
            border-left: 4px solid #ef4444; /* Red border on the left */
        }
        .duplicate-entry:hover {
            background-color: rgba(255, 0, 0, 0.25); /* Darker red on hover */
        }

        /* Sortable table headers */
        th[data-sort-by] {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        /* --- Table specific styling for Sidik Jari Status --- */
        .sidik-jari-terdaftar {
            background-color: rgba(144, 238, 144, 0.1); /* Light green soft */
            color: #90ee90; /* Matching text color */
        }
        .sidik-jari-belum-terdaftar {
            background-color: rgba(255, 99, 71, 0.1); /* Tomato red soft */
            color: #ff6347; /* Matching text color */
        }

        .sort-arrow {
            margin-left: 5px;
            font-size: 0.8em;
            vertical-align: middle;
            opacity: 0.5;
            transition: opacity 0.2s ease-in-out;
        }
        .sort-arrow.active { opacity: 1; }
        .sort-arrow.asc::after { content: ' ▲'; }
        .sort-arrow.desc::after { content: ' ▼'; }

        /* --- Modal Styles --- */
        .modal {
            position:fixed;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            background:rgba(0,0,0,0.5);
            z-index:1000;
        }
        .modal-card {
            background: white;
            color: #111827;
            width: 460px; /* Lebih lebar untuk form karyawan */
            max-width: 94%;
            border-radius: 10px;
            padding:20px; /* Lebih banyak padding */
            box-shadow:0 12px 36px rgba(0,0,0,0.4);
        }
        .modal-card h3 { margin:0 0 12px 0; font-size:20px; } /* Lebih besar */
        .form-row { margin-bottom:12px; }
        .form-row label { display:block; font-size:13px; margin-bottom:6px; color:#374151; }
        .form-row input {
            width:100%;
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #d1d5db;
            box-sizing:border-box;
            font-size:14px;
            color: #111827;
        }
        .form-row input::placeholder { color: #6b7280; }
        .hidden { display:none; }

        /* --- Report Box (for Excel Upload) --- */
        #reportBox {
            margin-top: 1rem;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
        }
        #uploadReport {
            white-space: pre-wrap;
            font-size: 14px;
            color: #fbbf24;
        }

        /* --- Summary Report Box --- */
        #summaryReport {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            display: none; /* Default hidden, will be shown by JS */
        }
        #summaryReport h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
            color: #a5b4fc;
        }
        #activeEmployeeSummaryList {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 14px;
        }
        #activeEmployeeSummaryList li {
            margin-bottom: 5px;
        }


        /* --- Footer Styles --- */
        footer {
            text-align: center;
            padding: 1rem;
            font-size: .9rem;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
            box-shadow: 0 -2px 3px rgba(0,0,0,0.1);
        }
        footer a { color: white; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
            nav .brand { margin-bottom: 10px; }
            nav .menu {
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
                margin-bottom: 10px;
                gap: 5px;
            }
            .menu-icon-link { padding: 5px 8px; }
            .right-nav-items {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            .user-info { font-size: 0.8em; }
            nav .menu2 { padding: 0.4rem 0.8rem; font-size: 0.8em; }
            .container { padding: 12px; }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            #searchInput { min-width: unset; width: 100%; }
            .btn, .file-input-label { width: 100%; }
            table { min-width: 600px; } /* Sesuaikan agar tetap readable */
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="main-content-wrapper">
        <div class="container" id="adminUploadContainer">
            <h2>Kelola Data Karyawan</h2>

            <div class="controls">
                <label for="excelFile" class="file-input-label">⬆️ Unggah Excel</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <button class="btn btn-secondary" id="downloadTemplateBtn">⬇️ Download Template</button>
                <button class="btn btn-info" id="addEmployeeBtn">➕ Tambah Karyawan</button>
                <button class="btn btn-ghost" id="refreshEmployeeDataBtn">🔄 Refresh Data</button>
                <button class="btn btn-primary" id="downloadAllDataBtn">💾 Download Semua Data</button> <!-- TOMBOL BARU DI SINI -->
                <input type="text" id="searchInput" placeholder="Cari NIK/Nama Karyawan...">
                <button class="btn btn-primary" id="deleteSelectedBtn" style="display:none;">🗑️ Hapus Terpilih (<span id="selectedCount">0</span>)</button>
            </div>

            <div id="summaryReport">
                <h3>Ringkasan Karyawan Aktif per Perusahaan</h3>
                <ul id="activeEmployeeSummaryList">
                    <!-- Ringkasan akan diisi di sini -->
                </ul>
            </div>

            <div class="status-message" id="pageStatus">Memuat data karyawan...</div>

            <div class="table-wrap">
                <table id="employeesTable">
                     <thead id="employeesTableHead">
                        <tr>
                            <th class="sticky-col-1" style="width: 30px;"><input type="checkbox" id="selectAllCheckbox"></th>
                            <th class="sticky-col-2" style="width:50px">No</th>
                            <th data-sort-by="ID Mesin">ID Mesin <span class="sort-arrow"></span></th>
                            <th data-sort-by="NIK Sebelumnya">NIK Sebelumnya <span class="sort-arrow"></span></th>
                            <th data-sort-by="NIK">NIK <span class="sort-arrow"></span></th>
                            <th data-sort-by="Nama">Nama Karyawan <span class="sort-arrow"></span></th>
                            <th data-sort-by="Status">Status <span class="sort-arrow"></span></th>
                            <th data-sort-by="Perusahaan">Perusahaan <span class="sort-arrow"></span></th>
                            <th data-sort-by="Department">Department <span class="sort-arrow"></span></th>
                            <th data-sort-by="Jabatan">Jabatan <span class="sort-arrow"></span></th>
                            <th data-sort-by="Sidik Jari Status">Sidik Jari <span class="sort-arrow"></span></th> <!-- Kolom baru untuk status sidik jari -->
                            <th data-sort-by="createdAt">Dibuat <span class="sort-arrow"></span></th>
                            <th data-sort-by="updatedAt">Diperbarui <span class="sort-arrow"></span></th>
                            <th style="width:150px">Aksi</th>
                        </tr>
                    </thead>

                    <tbody id="employeesTbody">
                        <!-- rows inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Report Box for Excel Upload -->
            <div id="reportBox" style="margin-top:1rem; display:none;">
                <div id="uploadReport" style="white-space:pre-wrap; font-size:14px; color:#fbbf24;"></div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button id="downloadReportBtn" class="btn btn-ghost small">
                        ⬇️ Download Report Skipped/Overwritten
                    </button>
                    <button id="discardReportBtn" class="btn btn-ghost small">
                        ❌ Buang Report
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal: Add/Edit Karyawan -->
    <div id="employeeModal" class="modal hidden" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalEmployeeTitle">
            <h3 id="modalEmployeeTitle">Tambah Karyawan</h3>
            <!-- Existing fields -->
            <div class="form-row">
                <label for="inputIDMesin">ID Mesin</label>
                <input id="inputIDMesin" type="text" placeholder="ID Mesin (mis: 1)">
            </div>
            <div class="form-row">
                <label for="inputNIKSebelumnya">NIK Sebelumnya</label>
                <input id="inputNIKSebelumnya" type="text" placeholder="NIK Sebelumnya (jika ada)">
            </div>
            <div class="form-row">
                <label for="inputNIK">NIK</label>
                <input id="inputNIK" type="text" placeholder="Nomor Induk Karyawan">
            </div>
            <div class="form-row">
                <label for="inputNama">Nama Karyawan</label>
                <input id="inputNama" type="text" placeholder="Nama Lengkap Karyawan">
            </div>
            <div class="form-row">
                <label for="inputStatus">Status</label>
                <input id="inputStatus" type="text" placeholder="Status Karyawan (mis: Aktif, Cuti)">
            </div>
            <div class="form-row">
                <label for="inputPerusahaan">Perusahaan</label>
                <input id="inputPerusahaan" type="text" placeholder="Nama Perusahaan">
            </div>
            <div class="form-row">
                <label for="inputDepartment">Department</label>
                <input id="inputDepartment" type="text" placeholder="Department Karyawan">
            </div>
            <div class="form-row">
                <label for="inputJabatan">Jabatan</label>
                <input id="inputJabatan" type="text" placeholder="Jabatan Karyawan">
            </div>
            <div class="form-row">
                <label for="inputSidikJari">Sidik Jari</label>
                <input id="inputSidikJari" type="text" placeholder="Data Sidik Jari (biarkan kosong jika Belum Terdaftar)">
            </div>
            <!-- End of new fields -->

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                <button id="cancelEmployeeBtn" class="btn btn-secondary small">Batal</button>
                <button id="saveEmployeeBtn" class="btn btn-primary small">Simpan</button>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script type="module">
        // ==========================================================
        //  1. JavaScript: Initialisasi dan Import
        // ==========================================================
        import { initPage } from "./common-ui.js";
        import { auth, db } from "./firebase-config.js";
        import {
            collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc,
            serverTimestamp, query, where, orderBy, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Inisialisasi halaman (ini akan memuat header/footer dan set judul)
        document.addEventListener('DOMContentLoaded', () => {
            initPage("Kelola Data Karyawan", "adminUploadContainer", "admin");
            // Autentikasi dan dapatkan data pengguna
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    currentUserData = userDocSnap.exists() ? userDocSnap.data() : { username: user.email || user.uid };
                } else {
                    currentUserData = null;
                    // Redirect ke login jika tidak ada user (opsional)
                    // window.location.href = "/login.html";
                }
            });
            loadEmployees(); // Muat data karyawan saat halaman pertama kali dibuka
        });

        const XLSX = window.XLSX;
        if (!XLSX) {
            console.error("SheetJS (xlsx.full.min.js) tidak dimuat dengan benar. Pastikan path-nya benar dan dimuat sebelum script ini.");
            setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
        }

        // ==========================================================
        //  2. JavaScript: Referensi Elemen DOM (HTML)
        // ==========================================================
        const pageStatus = document.getElementById("pageStatus");
        const employeesTbody = document.getElementById("employeesTbody");
        const employeesTableHead = document.getElementById("employeesTableHead");
        const addEmployeeBtn = document.getElementById("addEmployeeBtn");
        const refreshEmployeeDataBtn = document.getElementById("refreshEmployeeDataBtn");
        const searchInput = document.getElementById("searchInput");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");
        const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
        const selectedCountSpan = document.getElementById("selectedCount");
        const downloadAllDataBtn = document.getElementById("downloadAllDataBtn"); // BARU

        // Modal elements
        const employeeModal = document.getElementById("employeeModal");
        const modalEmployeeTitle = document.getElementById("modalEmployeeTitle");
        const inputIDMesin = document.getElementById("inputIDMesin");
        const inputNIKSebelumnya = document.getElementById("inputNIKSebelumnya");
        const inputNIK = document.getElementById("inputNIK");
        const inputNama = document.getElementById("inputNama");
        const inputStatus = document.getElementById("inputStatus");
        const inputPerusahaan = document.getElementById("inputPerusahaan");
        const inputDepartment = document.getElementById("inputDepartment");
        const inputJabatan = document.getElementById("inputJabatan");
        const inputSidikJari = document.getElementById("inputSidikJari");
        const cancelEmployeeBtn = document.getElementById("cancelEmployeeBtn");
        const saveEmployeeBtn = document.getElementById("saveEmployeeBtn");

        // Excel Upload Elements
        const excelFile = document.getElementById('excelFile');
        const reportBox = document.getElementById("reportBox");
        const uploadReport = document.getElementById("uploadReport");
        const downloadReportBtn = document.getElementById("downloadReportBtn");
        const discardReportBtn = document.getElementById("discardReportBtn");

        // Template Download Elements
        const downloadTemplateBtn = document.getElementById("downloadTemplateBtn");

        // Summary Report Elements
        const summaryReport = document.getElementById("summaryReport");
        const activeEmployeeSummaryList = document.getElementById("activeEmployeeSummaryList");

        // ==========================================================
        //  3. JavaScript: Variabel Global dan State
        // ==========================================================
        let allEmployeesData = []; // Semua data karyawan dari Firestore
        let currentDisplayData = []; // Data yang sedang ditampilkan (setelah filter/sort)
        let editingEmployeeId = null; // ID dokumen yang sedang diedit
        let currentSelectedEmployeeIds = new Set(); // ID dokumen yang dipilih untuk hapus banyak
        let sortState = { column: 'createdAt', direction: 'desc' }; // State sorting tabel
        let currentUserData = null; // Informasi user yang sedang login
        let uploadExcelReportData = []; // Data untuk report Excel upload

        // ==========================================================
        //  4. JavaScript: Fungsi Utility (Pembantu)
        // ==========================================================
        function esc(str) {
            if (str === undefined || str === null) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setStatus(message, type = 'info') {
            pageStatus.textContent = message;
            pageStatus.className = `status-message ${type}`;
        }

        function openEmployeeModal() {
            employeeModal.classList.remove("hidden");
            employeeModal.setAttribute("aria-hidden", "false");
            inputNIK.focus(); // Fokus ke NIK saat modal dibuka
        }

        function closeEmployeeModal() {
            employeeModal.classList.add("hidden");
            employeeModal.setAttribute("aria-hidden", "true");
        }

        // --- Logging Function ---
        async function logEmployeeAction(action, docId, oldData, newData, context = {}) {
            if (!auth.currentUser || !currentUserData) {
                console.warn("Tidak dapat membuat log: Pengguna tidak terautentikasi atau data pengguna tidak tersedia.");
                return;
            }

            const logEntry = {
                collection: "employees_mapping",
                documentId: docId,
                action: action,
                timestamp: serverTimestamp(),
                changedByUid: auth.currentUser.uid,
                changedByName: currentUserData.username || auth.currentUser.email,
                ...context // Tambahkan konteks tambahan seperti 'source: "excel_upload"'
            };

            if (action === "create" || action === "create_from_excel") {
                logEntry.newData = newData;
            } else if (action === "update" || action === "update_from_excel") {
                const changes = {};
                // Compare new data with old data, excluding special fields like createdAt/By, updatedAt/By
                // Also ensures comparison is always string to string (trimming whitespace)
                const fieldsToCompare = Object.keys({ ...oldData, ...newData })
                                            .filter(key => !['createdAt', 'createdBy', 'updatedAt', 'updatedBy', 'source'].includes(key));

                for (const key of fieldsToCompare) {
                    const oldVal = (oldData[key] !== null && oldData[key] !== undefined) ? String(oldData[key]).trim() : null;
                    const newVal = (newData[key] !== null && newData[key] !== undefined) ? String(newData[key]).trim() : null;

                    if (oldVal !== newVal) {
                        changes[key] = { old: oldData[key], new: newData[key] };
                    }
                }

                if (Object.keys(changes).length > 0) { // Only log if there were actual changes
                    logEntry.changes = changes;
                    logEntry.oldData = oldData;
                    logEntry.newData = newData;
                } else {
                    return; // No actual changes, don't log
                }
            } else if (action === "delete" || action === "delete_batch") {
                logEntry.oldData = oldData;
            }
            await addDoc(collection(db, "employees_logs"), logEntry);
        }

        // --- Fungsi Generate Ringkasan Karyawan Aktif ---
        function generateActiveEmployeeSummary() {
            const activeEmployeesByCompany = {};

            // 1. Filter dan Kelompokkan
            allEmployeesData.forEach(employee => {
                const status = String(employee.data.Status || '').toLowerCase(); // Ambil status, jadikan lowercase
                const perusahaan = String(employee.data.Perusahaan || 'Tanpa Perusahaan').trim(); // Ambil nama perusahaan

                if (status === 'aktif') { // Asumsi 'Aktif' adalah status karyawan aktif
                    if (!activeEmployeesByCompany[perusahaan]) {
                        activeEmployeesByCompany[perusahaan] = 0;
                    }
                    activeEmployeesByCompany[perusahaan]++;
                }
            });

            // 2. Tampilkan Hasil di UI
            activeEmployeeSummaryList.innerHTML = ''; // Bersihkan daftar sebelumnya
            if (Object.keys(activeEmployeesByCompany).length === 0) {
                activeEmployeeSummaryList.innerHTML = '<li>Tidak ada karyawan aktif ditemukan.</li>';
                summaryReport.style.display = 'block'; // Tampilkan walaupun kosong
                return;
            }

            let totalAktif = 0;
            for (const perusahaan in activeEmployeesByCompany) {
                const count = activeEmployeesByCompany[perusahaan];
                activeEmployeeSummaryList.innerHTML += `<li><strong>${esc(perusahaan)}</strong>: ${count} karyawan aktif</li>`;
                totalAktif += count;
            }
            activeEmployeeSummaryList.innerHTML += `<li style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;"><strong>Total Karyawan Aktif: ${totalAktif}</strong></li>`;
            summaryReport.style.display = 'block'; // Tampilkan summary box
        }


        // ==========================================================
        //  5. JavaScript: Logika Rendering Tabel & Filter/Sort
        // ==========================================================
        function renderTable(employeesToRender) {
            employeesTbody.innerHTML = "";
            if (employeesToRender.length === 0) {
                // Perbarui colspan sesuai jumlah kolom
                employeesTbody.innerHTML = `<tr><td colspan="14" class="muted">Belum ada karyawan terdaftar atau tidak ditemukan.</td></tr>`;
                return;
            }

            let index = 0;
            employeesToRender.forEach(employee => {
                index++;
                const d = employee.data;
                const id = employee.id;

                const createdDate = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : (d.createdAt instanceof Date ? d.createdAt : null);
                const created = createdDate ? createdDate.toLocaleString() : "-";
                // UpdatedAt dan UpdatedBy hanya ditampilkan jika ada
                const updatedDate = d.updatedAt && d.updatedAt.toDate ? d.updatedAt.toDate() : (d.updatedAt instanceof Date ? d.updatedAt : null);
                const updated = updatedDate ? updatedDate.toLocaleString() : "-";

                const isSelected = currentSelectedEmployeeIds.has(id);
                const tr = document.createElement("tr");
                // if (d.updatedAt) { // Hanya tandai jika updatedBy memang ada
                //     tr.classList.add("updated-row");
                // }

                // Logika untuk status sidik jari
                const sidikJariValue = d['Sidik Jari'] || '';
                let sidikJariDisplay = '';
                let sidikJariClass = '';

                if (sidikJariValue && String(sidikJariValue).trim() !== '') {
                    sidikJariDisplay = 'Terdaftar';
                    sidikJariClass = 'sidik-jari-terdaftar';
                } else {
                    sidikJariDisplay = 'Belum Terdaftar';
                    sidikJariClass = 'sidik-jari-belum-terdaftar';
                }

                tr.innerHTML = `
                    <td><input type="checkbox" class="employee-checkbox" data-id="${id}" ${isSelected ? 'checked' : ''}></td>
                    <td>${index}</td>
                    <td>${esc(d['ID Mesin'] || '-')}</td>
                    <td>${esc(d['NIK Sebelumnya'] || '-')}</td>
                    <td>${esc(d.NIK || '-')}</td>
                    <td>${esc(d.Nama || '-')}</td>
                    <td>${esc(d.Status || '-')}</td>
                    <td>${esc(d.Perusahaan || '-')}</td>
                    <td>${esc(d.Department || '-')}</td>
                    <td>${esc(d.Jabatan || '-')}</td>
                    <td class="${sidikJariClass}">${sidikJariDisplay}</td>
                    <td class="muted">${created}</td>
                    <td class="muted">${updated}</td>
                    <td>
                        <button class="icon-btn" data-action="edit" data-id="${id}">✏️ Edit</button>
                        <button class="icon-btn" data-action="delete" data-id="${id}">🗑️ Hapus</button>
                    </td>
                `;
                employeesTbody.appendChild(tr);
            });
            updateSelectAllCheckboxState(); // Update status checkbox select all
            updateDeleteSelectedButtonVisibility(); // Update status tombol hapus banyak
        }

        function updateSelectAllCheckboxState() {
            const allCheckboxes = document.querySelectorAll(".employee-checkbox");
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        function updateDeleteSelectedButtonVisibility() {
            selectedCountSpan.textContent = currentSelectedEmployeeIds.size;
            if (currentSelectedEmployeeIds.size > 0) {
                deleteSelectedBtn.style.display = "inline-block";
            } else {
                deleteSelectedBtn.style.display = "none";
            }
        }

        function applySortAndFilter() {
            let dataToProcess = [...allEmployeesData];

            // 1. Apply filter
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm !== "") {
                dataToProcess = dataToProcess.filter(employee => {
                    const d = employee.data;
                    const idMesin = (d['ID Mesin'] || "").toLowerCase();
                    const nikSebelumnya = (d['NIK Sebelumnya'] || "").toLowerCase();
                    const nik = (d.NIK || "").toLowerCase();
                    const nama = (d.Nama || "").toLowerCase();
                    const status = (d.Status || "").toLowerCase();
                    const perusahaan = (d.Perusahaan || "").toLowerCase();
                    const Department = (d.Department || "").toLowerCase();
                    const jabatan = (d.Jabatan || "").toLowerCase();
                    // Untuk pencarian sidik jari, bisa cari 'terdaftar'/'belum terdaftar'
                    const sidikJariStatus = (d['Sidik Jari'] && String(d['Sidik Jari']).trim() !== '') ? 'terdaftar' : 'belum terdaftar';

                    return idMesin.includes(searchTerm) ||
                           nikSebelumnya.includes(searchTerm) ||
                           nik.includes(searchTerm) ||
                           nama.includes(searchTerm) ||
                           status.includes(searchTerm) ||
                           perusahaan.includes(searchTerm) ||
                           Department.includes(searchTerm) ||
                           jabatan.includes(searchTerm) ||
                           sidikJariStatus.includes(searchTerm);
                });
            }

            // 2. Apply sort
            if (sortState.column) {
                dataToProcess.sort((a, b) => {
                    let valA, valB;
                    if (['ID Mesin', 'NIK Sebelumnya', 'NIK', 'Nama', 'Status', 'Perusahaan', 'Department', 'Jabatan'].includes(sortState.column)) {
                        valA = (a.data[sortState.column] || '').toLowerCase();
                        valB = (b.data[sortState.column] || '').toLowerCase();
                    } else if (sortState.column === 'Sidik Jari Status') {
                        valA = (a.data['Sidik Jari'] && String(a.data['Sidik Jari']).trim() !== '') ? 'terdaftar' : 'belum terdaftar';
                        valB = (b.data['Sidik Jari'] && String(b.data['Sidik Jari']).trim() !== '') ? 'terdaftar' : 'belum terdaftar';
                    } else if (sortState.column === 'createdAt' || sortState.column === 'updatedAt') {
                        valA = a.data[sortState.column] ? (a.data[sortState.column].toDate ? a.data[sortState.column].toDate().getTime() : new Date(a.data[sortState.column]).getTime()) : 0;
                        valB = b.data[sortState.column] ? (b.data[sortState.column].toDate ? b.data[sortState.column].toDate().getTime() : new Date(b.data[sortState.column]).getTime()) : 0;
                    } else {
                        valA = a.data[sortState.column];
                        valB = b.data[sortState.column];
                    }

                    // Handle null/undefined/empty string values for comparison
                    if (typeof valA === 'string' && (valA === null || valA === undefined || valA === '')) valA = sortState.direction === 'asc' ? '' : 'zzzzz';
                    if (typeof valB === 'string' && (valB === null || valB === undefined || valB === '')) valB = sortState.direction === 'asc' ? '' : 'zzzzz';

                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            currentDisplayData = dataToProcess;
            renderTable(currentDisplayData);
            updateSortArrows();
        }

        function updateSortArrows() {
            employeesTableHead.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.classList.remove('active', 'asc', 'desc');
            });

            const activeTh = employeesTableHead.querySelector(`th[data-sort-by="${sortState.column}"]`);
            if (activeTh) {
                const activeArrow = activeTh.querySelector('.sort-arrow');
                if (activeArrow) {
                    activeArrow.classList.add('active', sortState.direction);
                }
            }
        }

        // Helper to check for duplicate NIK
        async function checkDuplicateNIK(nik, currentDocId = null) {
            const q = query(collection(db, "employees_mapping"), where("NIK", "==", nik));
            const snap = await getDocs(q);
            let isDuplicate = false;
            snap.forEach(doc => {
                if (doc.id !== currentDocId) {
                    isDuplicate = true;
                }
            });
            return isDuplicate;
        }

        // ==========================================================
        //  6. JavaScript: Fungsi Utama Pengelolaan Data (Firestore)
        // ==========================================================
        async function loadEmployees() {
            setStatus("Memuat data karyawan...", 'info');
            try {
                // Default sorting order
                const q = query(collection(db, "employees_mapping"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);

                allEmployeesData = [];
                snap.forEach(docSnap => {
                    allEmployeesData.push({ id: docSnap.id, data: docSnap.data() });
                });

                applySortAndFilter(); // Terapkan sorting dan filter awal
                generateActiveEmployeeSummary(); // Panggil fungsi ringkasan di sini
                setStatus(`Selesai memuat (${allEmployeesData.length} karyawan).`, 'success');
            } catch (err) {
                console.error(err);
                setStatus("Gagal memuat data karyawan. Cek konsol.", 'error');
                employeesTbody.innerHTML = `<tr><td colspan="14" class="muted">Error saat memuat data.</td></tr>`;
                summaryReport.style.display = 'none'; // Sembunyikan summary jika ada error
            }
        }

        // ==========================================================
        //  7. JavaScript: Event Listeners
        // ==========================================================

        // Refresh Data Karyawan
        refreshEmployeeDataBtn.addEventListener("click", () => {
            searchInput.value = ""; // Clear search
            sortState = { column: 'createdAt', direction: 'desc' }; // Reset sort
            currentSelectedEmployeeIds.clear(); // Clear selections
            loadEmployees();
        });

        // Add New Employee Button
        addEmployeeBtn.addEventListener("click", () => {
            editingEmployeeId = null;
            modalEmployeeTitle.textContent = "Tambah Karyawan Baru";
            inputIDMesin.value = "";
            inputNIKSebelumnya.value = "";
            inputNIK.value = "";
            inputNIK.disabled = false; // NIK bisa diisi saat tambah baru
            inputNama.value = "";
            inputStatus.value = "";
            inputPerusahaan.value = "";
            inputDepartment.value = "";
            inputJabatan.value = "";
            inputSidikJari.value = "";
            openEmployeeModal();
        });

        // Cancel Employee Modal Button
        cancelEmployeeBtn.addEventListener("click", closeEmployeeModal);

        // Save Employee (Add/Edit)
        saveEmployeeBtn.addEventListener("click", async () => {
            const idMesin = inputIDMesin.value.trim();
            const nikSebelumnya = inputNIKSebelumnya.value.trim();
            const nik = inputNIK.value.trim();
            const nama = inputNama.value.trim();
            const status = inputStatus.value.trim();
            const perusahaan = inputPerusahaan.value.trim();
            const department = inputDepartment.value.trim();
            const jabatan = inputJabatan.value.trim();
            const sidikJari = inputSidikJari.value.trim();

            if (!nik || !nama) {
                alert("NIK dan Nama Karyawan wajib diisi.");
                saveEmployeeBtn.disabled = false; // Enable button again
                return;
            }

            saveEmployeeBtn.disabled = true;
            try {
                // Prepare data from modal fields, setting empty strings to null
                const employeeData = {
                    'ID Mesin': idMesin || null,
                    'NIK Sebelumnya': nikSebelumnya || null,
                    NIK: nik,
                    Nama: nama,
                    Status: status || null,
                    Perusahaan: perusahaan || null,
                    Department: department || null,
                    Jabatan: jabatan || null,
                    'Sidik Jari': sidikJari || null,
                };

                if (editingEmployeeId) { // Edit Existing
                    const ref = doc(db, "employees_mapping", editingEmployeeId);
                    const beforeSnap = await getDoc(ref);
                    const beforeData = beforeSnap.exists() ? beforeSnap.data() : {};

                    await updateDoc(ref, {
                        ...employeeData, // Existing data is overwritten by new employeeData
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUserData?.username || auth.currentUser.uid
                    });
                    await logEmployeeAction("update", editingEmployeeId, beforeData, employeeData);

                    setStatus("Data karyawan berhasil diperbarui.", 'success');
                } else { // Add New
                    // Check for duplicate NIK before adding
                    const isDuplicate = await checkDuplicateNIK(nik);
                    if (isDuplicate) {
                        alert("NIK ini sudah ada. Harap gunakan NIK yang unik.");
                        saveEmployeeBtn.disabled = false;
                        return;
                    }

                    // Use NIK as the document ID
                    await setDoc(doc(db, "employees_mapping", nik), {
                        ...employeeData,
                        createdAt: serverTimestamp(),
                        createdBy: currentUserData?.username || auth.currentUser.uid
                        // updatedAt dan updatedBy sengaja TIDAK ditambahkan di sini
                        // karena ini adalah data baru, belum pernah diupdate.
                    });
                    await logEmployeeAction("create", nik, null, employeeData);

                    setStatus("Karyawan baru berhasil ditambahkan.", 'success');
                }
                closeEmployeeModal();
                await loadEmployees(); // Reload data to show changes
            } catch (err) {
                console.error(err);
                alert("Gagal menyimpan data karyawan: " + (err.message || err));
                setStatus("Gagal menyimpan.", 'error');
            } finally {
                saveEmployeeBtn.disabled = false;
            }
        });

        // Table Body Click Listener (for Edit/Delete single item)
        employeesTbody.addEventListener("click", async (ev) => {
            const btn = ev.target.closest("button");
            if (!btn) return;
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (!action || !id) return;

            if (action === "edit") {
                try {
                    const snap = await getDoc(doc(db, "employees_mapping", id));
                    if (!snap.exists()) {
                        alert("Data karyawan tidak ditemukan.");
                        return;
                    }
                    const d = snap.data();
                    editingEmployeeId = id;
                    modalEmployeeTitle.textContent = "Edit Karyawan";
                    inputIDMesin.value = d['ID Mesin'] || "";
                    inputNIKSebelumnya.value = d['NIK Sebelumnya'] || "";
                    inputNIK.value = d.NIK || "";
                    inputNIK.disabled = true; // NIK tidak bisa diedit setelah dibuat
                    inputNama.value = d.Nama || "";
                    inputStatus.value = d.Status || "";
                    inputPerusahaan.value = d.Perusahaan || "";
                    inputDepartment.value = d.Department || "";
                    inputJabatan.value = d.Jabatan || "";
                    inputSidikJari.value = d['Sidik Jari'] || "";
                    openEmployeeModal();
                } catch (err) {
                    console.error(err);
                    alert("Gagal memuat data karyawan untuk edit.");
                }
            } else if (action === "delete") {
                if (!confirm("Yakin ingin menghapus karyawan ini? Tindakan ini tidak bisa dibatalkan.")) return;

                try {
                    const ref = doc(db, "employees_mapping", id);
                    const beforeSnap = await getDoc(ref);
                    if (!beforeSnap.exists()) {
                        alert("Karyawan sudah tidak ada.");
                        return;
                    }
                    const before = beforeSnap.data(); // Simpan data sebelum dihapus

                    await deleteDoc(ref);
                    await logEmployeeAction("delete", id, before, null);

                    setStatus("Karyawan berhasil dihapus.", 'success');
                    await loadEmployees(); // Reload data to show changes
                    currentSelectedEmployeeIds.delete(id); // Hapus dari seleksi jika ada
                    updateDeleteSelectedButtonVisibility();
                } catch (err) {
                    console.error(err);
                    alert("Gagal menghapus karyawan: " + (err.message || err));
                    setStatus("Gagal menghapus.", 'error');
                }
            }
        });

        // Individual Checkbox Click Listener
        employeesTbody.addEventListener("change", (e) => {
            if (e.target.classList.contains("employee-checkbox")) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    currentSelectedEmployeeIds.add(id);
                } else {
                    currentSelectedEmployeeIds.delete(id);
                }
                updateSelectAllCheckboxState();
                updateDeleteSelectedButtonVisibility();
            }
        });

        // Select All Checkbox
        selectAllCheckbox.addEventListener("change", (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll(".employee-checkbox").forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    currentSelectedEmployeeIds.add(checkbox.dataset.id);
                } else {
                    currentSelectedEmployeeIds.delete(checkbox.dataset.id);
                }
            });
            updateDeleteSelectedButtonVisibility();
        });

        // Delete Selected Button
        deleteSelectedBtn.addEventListener("click", async () => {
            if (currentSelectedEmployeeIds.size === 0) {
                alert("Tidak ada karyawan yang dipilih untuk dihapus.");
                return;
            }
            if (!confirm(`Yakin ingin menghapus ${currentSelectedEmployeeIds.size} karyawan terpilih? Tindakan ini tidak bisa dibatalkan.`)) return;

            setStatus(`Menghapus ${currentSelectedEmployeeIds.size} karyawan terpilih...`, 'info');
            deleteSelectedBtn.disabled = true;
            let batch = writeBatch(db); // Deklarasi batch di sini
            let deletedCount = 0;

            try {
                for (const id of currentSelectedEmployeeIds) {
                    const ref = doc(db, "employees_mapping", id);
                    const beforeSnap = await getDoc(ref);
                    if (beforeSnap.exists()) {
                        batch.delete(ref);
                        await logEmployeeAction("delete_batch", id, beforeSnap.data(), null);
                        deletedCount++;
                    } else {
                        console.warn(`Dokumen dengan ID ${id} tidak ditemukan, mungkin sudah dihapus.`);
                    }
                }
                await batch.commit();
                setStatus(`${deletedCount} karyawan berhasil dihapus.`, 'success');
                currentSelectedEmployeeIds.clear(); // Clear selection
                await loadEmployees(); // Reload data
            } catch (err) {
                console.error(err);
                alert("Gagal menghapus karyawan terpilih: " + (err.message || err));
                setStatus("Gagal menghapus.", 'error');
            } finally {
                deleteSelectedBtn.disabled = false;
            }
        });

        // Search Input Listener
        searchInput.addEventListener("input", () => {
            applySortAndFilter();
        });

        // Table Header Click Listener (for Sorting)
        employeesTableHead.addEventListener("click", (e) => {
            const targetTh = e.target.closest("th[data-sort-by]");
            if (!targetTh) return;

            const column = targetTh.dataset.sortBy;
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            applySortAndFilter();
        });

        // --- Template Download Listener ---
        downloadTemplateBtn.addEventListener("click", () => {
            if (typeof XLSX === 'undefined') {
                setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
                return;
            }

            const headers = [
                "ID Mesin",
                "NIK Sebelumnya",
                "NIK",
                "Nama",
                "Status",
                "Perusahaan",
                "Department",
                "Jabatan",
                "Sidik Jari"
            ];

            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Karyawan");
            XLSX.writeFile(wb, "template_data_karyawan.xlsx");

            setStatus("Template Excel berhasil diunduh.", 'success');
        });

        // --- Fungsi BARU: Download Semua Data ke Excel ---
        downloadAllDataBtn.addEventListener("click", () => {
            if (typeof XLSX === 'undefined') {
                setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
                return;
            }
            if (currentDisplayData.length === 0) {
                setStatus("Tidak ada data untuk diunduh.", 'info');
                return;
            }

            setStatus("Mempersiapkan data untuk diunduh...", 'info');

            const headers = [
                "ID Mesin", "NIK Sebelumnya", "NIK", "Nama", "Status",
                "Perusahaan", "Department", "Jabatan", "Sidik Jari",
                "Sidik Jari Status", // Tambahkan kolom status sidik jari yang sudah diolah
                "Dibuat Pada", "Dibuat Oleh", "Diperbarui Pada", "Diperbarui Oleh"
            ];

            const dataToExport = currentDisplayData.map(employee => {
                const d = employee.data;
                const sidikJariValue = d['Sidik Jari'] || '';
                const sidikJariStatusText = (sidikJariValue && String(sidikJariValue).trim() !== '') ? 'Terdaftar' : 'Belum Terdaftar';

                return [
                    d['ID Mesin'] || '',
                    d['NIK Sebelumnya'] || '',
                    d.NIK || '',
                    d.Nama || '',
                    d.Status || '',
                    d.Perusahaan || '',
                    d.Department || '',
                    d.Jabatan || '',
                    d['Sidik Jari'] || '',
                    sidikJariStatusText, // Nilai status sidik jari
                    d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '',
                    d.createdBy || '',
                    d.updatedAt && d.updatedAt.toDate ? d.updatedAt.toDate().toLocaleString() : '',
                    d.updatedBy || ''
                ];
            });

            const ws = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Karyawan");
            XLSX.writeFile(wb, "data_karyawan_lengkap.xlsx");

            setStatus(`Berhasil mengunduh ${dataToExport.length} baris data karyawan.`, 'success');
        });


        // --- Excel Upload Functions ---
        excelFile.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
                return;
            }

            setStatus("Membaca file Excel...", 'info');
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert to JSON with header row as keys
                    const rawExcelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                    if (rawExcelData.length < 2) { // Minimum 1 header + 1 data row (header + one data row)
                        setStatus("File Excel kosong atau hanya berisi header.", 'error');
                        excelFile.value = ""; // Reset file input
                        return;
                    }

                    // Define expected headers for strict mapping and reordering if needed
                    const expectedHeaders = [
                        "ID Mesin", "NIK Sebelumnya", "NIK", "Nama", "Status",
                        "Perusahaan", "Department", "Jabatan", "Sidik Jari"
                    ];
                    const fileHeaders = rawExcelData[0].map(h => String(h).trim());

                    // Validate headers
                    const missingHeaders = expectedHeaders.filter(h => !fileHeaders.includes(h));
                    if (missingHeaders.length > 0) {
                        setStatus(`Error: File Excel harus memiliki kolom berikut: ${missingHeaders.join(', ')}.`, 'error');
                        excelFile.value = "";
                        return;
                    }

                    const rows = rawExcelData.slice(1);

                    let newAddedCount = 0;
                    let uploadSkippedCount = 0; // For no changes
                    let uploadOverwrittenCount = 0; // For actual changes
                    uploadExcelReportData = []; // Reset report data

                    // Fetch existing NIKs for conflict checking
                    const existingNIKsSnap = await getDocs(collection(db, "employees_mapping"));
                    const existingNIKsMap = new Map(); // NIK -> doc.data()
                    existingNIKsSnap.forEach(doc => {
                        existingNIKsMap.set(doc.id, doc.data()); // Assuming NIK is doc.id
                    });

                    let batch = writeBatch(db); // Deklarasikan batch di sini
                    let currentBatchOps = 0;
                    const BATCH_MAX_OPS = 400; // Firestore limit 500 ops per batch, save some for logging

                    const userName = currentUserData?.username || auth.currentUser.uid;

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        let obj = {};
                        let isEmptyRow = true;
                        fileHeaders.forEach((header, index) => {
                            let value = row[index];
                            if (typeof value === 'string') {
                                value = value.trim();
                            }
                            // Store values as null if they are empty strings
                            obj[header] = (value === undefined || value === null || value === '') ? null : value;
                            if (obj[header] !== null) {
                                isEmptyRow = false;
                            }
                        });

                        if (isEmptyRow) {
                            uploadSkippedCount++;
                            uploadExcelReportData.push({
                                NIK: obj['NIK'] || '-',
                                Nama: obj['Nama'] || '-',
                                Reason: "Baris kosong dilewati"
                            });
                            continue;
                        }

                        const nik = String(obj['NIK'] || '').trim();
                        if (!nik) {
                            uploadSkippedCount++;
                            uploadExcelReportData.push({
                                NIK: obj['NIK'] || '-',
                                Nama: obj['Nama'] || '-',
                                Reason: "NIK kosong, baris dilewati"
                            });
                            continue;
                        }

                        // Prepare data for Firestore, ensuring only expected fields are saved
                        const dataToProcessFromExcel = {};
                        expectedHeaders.forEach(header => {
                            if (obj[header] !== undefined) {
                                dataToProcessFromExcel[header] = obj[header];
                            }
                        });

                        if (existingNIKsMap.has(nik)) {
                            // NIK sudah ada, ini adalah pembaruan
                            const oldData = existingNIKsMap.get(nik);

                            // Cek apakah ada perubahan data yang sebenarnya (diluar metadata)
                            let hasActualDataChanges = false;
                            for (const key of expectedHeaders) {
                                const oldValue = (oldData[key] !== null && oldData[key] !== undefined) ? String(oldData[key]).trim() : null;
                                const newValue = (dataToProcessFromExcel[key] !== null && dataToProcessFromExcel[key] !== undefined) ? String(dataToProcessFromExcel[key]).trim() : null;

                                if (oldValue !== newValue) {
                                    hasActualDataChanges = true;
                                    break;
                                }
                            }

                            if (!hasActualDataChanges) {
                                // Data sama, tidak perlu update. Lewati baris ini.
                                uploadSkippedCount++;
                                uploadExcelReportData.push({ NIK: nik, Nama: oldData.Nama || '-', Reason: "Data sama, tidak ada perubahan" });
                                continue;
                            }

                            // Jika ada perubahan, update updatedAt/updatedBy
                            const updateMetadata = {
                                updatedAt: serverTimestamp(),
                                updatedBy: userName,
                                source: "excel_upload"
                            };
                            const updatedData = { ...oldData, ...dataToProcessFromExcel, ...updateMetadata };
                            batch.set(doc(collection(db, "employees_mapping"), nik), updatedData);
                            await logEmployeeAction("update_from_excel", nik, oldData, updatedData, { source: "excel_upload" });
                            uploadOverwrittenCount++;
                        } else {
                            // NIK baru, ini adalah pembuatan
                            const creationMetadata = {
                                createdAt: serverTimestamp(),
                                createdBy: userName,
                                source: "excel_upload"
                            };
                            const newData = { ...dataToProcessFromExcel, ...creationMetadata };
                            batch.set(doc(collection(db, "employees_mapping"), nik), newData);
                            await logEmployeeAction("create_from_excel", nik, null, newData, { source: "excel_upload" });
                            newAddedCount++;
                        }
                        currentBatchOps++;

                        if (currentBatchOps >= BATCH_MAX_OPS) {
                            await batch.commit();
                            setStatus(`Mengunggah batch... Baru: ${newAddedCount}, Diubah: ${uploadOverwrittenCount}, Dilewati: ${uploadSkippedCount}.`, 'info');
                            currentBatchOps = 0;
                            batch = writeBatch(db); // Create a new batch instance for subsequent operations
                        }
                    } // End of for loop

                    // Commit any remaining operations in the last batch
                    if (currentBatchOps > 0) {
                        await batch.commit();
                    }

                    let msg = `Unggah Excel selesai.\n`;
                    if (newAddedCount > 0) msg += `Ditambahkan baru: ${newAddedCount}.\n`;
                    if (uploadOverwrittenCount > 0) msg += `Data diubah/ditimpa: ${uploadOverwrittenCount}.\n`;
                    if (uploadSkippedCount > 0) msg += `Baris dilewati: ${uploadSkippedCount}.`; // Including no-change skips

                    if (uploadExcelReportData.length > 0) {
                        msg += `\n\nBeberapa baris dilewati atau diubah. Lihat detail di Report Box.`;
                        reportBox.style.display = "block";
                        downloadReportBtn.dataset.skipped = JSON.stringify(uploadExcelReportData);
                    } else {
                        reportBox.style.display = "none";
                    }

                    uploadReport.textContent = msg;
                    setStatus("Unggah Excel selesai.", 'success');
                    await loadEmployees(); // Reload main table
                    excelFile.value = ""; // Reset file input
                } catch (error) {
                    setStatus(`Gagal memproses file Excel: ${error.message}. Pastikan format file benar dan kolom NIK ada.`, 'error');
                    console.error(error);
                } finally {
                    excelFile.value = ""; // Selalu reset input file
                }
            };
            reader.onerror = (error) => {
                setStatus(`Terjadi kesalahan saat membaca file: ${error}`, 'error');
                console.error(error);
            };
            reader.readAsArrayBuffer(file);
        });

        // Download Skipped/Overwritten Report
        downloadReportBtn.addEventListener("click", () => {
            const reportList = JSON.parse(downloadReportBtn.dataset.skipped || "[]");
            if (reportList.length === 0) return;

            const wbReport = XLSX.utils.book_new();
            const wsReport = XLSX.utils.aoa_to_sheet([
                ["NIK", "Nama", "Alasan"],
                ...reportList.map(item => [item.NIK, item.Nama, item.Reason])
            ]);
            XLSX.utils.book_append_sheet(wbReport, wsReport, "Report Upload");
            XLSX.writeFile(wbReport, "report_upload_karyawan.xlsx");

            reportBox.style.display = "none";
            uploadReport.textContent = "";
        });

        // Discard Report
        discardReportBtn.addEventListener("click", () => {
            if (confirm("Yakin mau buang report ini tanpa download? Report akan hilang permanen.")) {
                reportBox.style.display = "none";
                uploadReport.textContent = "";
                uploadExcelReportData = [];
                downloadReportBtn.dataset.skipped = "[]";
            }
        });

    </script>
</body>
</html>



