<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" type="image/png" href="images/icon.png">

    <title>Kelola Data Karyawan</title>

    <script src="./xlsx.full.min.js"></script>

    <style>
        /* --- General & Body Styles --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Navigation Styles (Diadaptasi dari skrip pertama untuk konsep menu ikon) --- */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            z-index: 10;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        nav .brand {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }
        nav .menu {
            display: flex;
            align-items: center;
            flex-grow: 1;
            justify-content: center;
            gap: 8px;
        }
        .menu-icon-link {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            text-decoration: none;
            color: white;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .menu-icon-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #a5b4fc;
        }
        .menu-icon-link .menu-icon {
            width: 33px;
            height: 33px;
            object-fit: contain;
        }
        .menu-icon-link .menu-text {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 1000;
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%) translateY(5px);
        }
        .menu-icon-link:hover .menu-text {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .menu-icon-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #a5b4fc;
        }
        .right-nav-items {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }
        nav .menu2 {
            color: white;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(255,255,255,0.1);
            transition: background 0.3s, transform 0.2s;
            font-weight: bold;
            font-size: 0.9em;
        }
        nav .menu2:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        /* --- Main Content Layout --- */
        .main-content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding: 2rem;
        }
        .container {
            background: rgba(255,255,255,0.06); /* Lebih transparan */
            padding: 1.25rem; /* Sedikit lebih kecil */
            border-radius: 12px; /* Lebih halus */
            width: 100%;
            max-width: 1100px; /* Lebih lebar */
            box-shadow: 0 10px 30px rgba(0,0,0,0.35); /* Lebih tegas */
            backdrop-filter: blur(6px); /* Blur lebih sedikit */
        }
        h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 26px;
        }

        /* --- Controls & Buttons --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Jarak antar item */
            margin-bottom: 20px;
            align-items: center;
            justify-content: flex-start; /* Sejajarkan ke kiri */
        }
        .btn {
            padding: 8px 12px; /* Lebih kecil */
            border: none;
            border-radius: 8px; /* Lebih halus */
            font-weight: 600; /* Lebih tebal */
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            font-size: 14px;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-primary { background: #4f46e5; color: #fff; }
        .btn-primary:hover { background: #4338ca; }
        .btn-secondary { background: #f59e0b; color: #fff; }
        .btn-secondary:hover { background: #d97706; }
        .btn-info { background: #3b82f6; color: #fff; }
        .btn-info:hover { background: #2563eb; }
        .btn-ghost {
            background: rgba(255,255,255,0.06);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        /* --- Form Input (for Modal and Search) --- */
        input[type="file"] {
            display: none; /* Sembunyikan input file asli */
        }
        .file-input-label { /* Label kustom untuk input file */
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, transform 0.2s;
            font-size: 14px;
        }
        .file-input-label:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        #searchInput {
            flex-grow: 1; /* Agar search input bisa mengisi ruang */
            min-width: 200px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            color: white;
            font-size: 14px;
        }
        #searchInput::placeholder {
            color: rgba(255,255,255,0.6);
        }
        #searchInput:focus {
            outline: none;
            border-color: #a5b4fc;
            box-shadow: 0 0 0 2px rgba(165, 180, 252, 0.3);
        }

        /* --- Status Message --- */
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            /* Default display: block; jika ingin selalu terlihat. Jika tidak, controlled by JS. */
        }
        .status-message.success { background-color: #10b981; color: white; }
        .status-message.error { background-color: #ef4444; color: white; }
        .status-message.info { background-color: #60a5fa; color: white; }

        /* --- Table Styles --- */
        .table-wrap {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            max-height: 520px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            color: white;
            min-width: 900px; /* Minimum width for the table */
        }
        th, td {
            border: 1px solid rgba(255,255,255,0.15); /* Border lebih halus */
            padding: 10px 12px; /* Padding lebih banyak */
            text-align: left;
            font-size: 13px;
        }
        th {
            background: rgba(255,255,255,0.1); /* Background header */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 2; /* Pastikan header sticky di atas konten lain saat scroll */
        }
        tbody tr:nth-child(odd) { background: rgba(255, 255, 255, 0.04); }
        tbody tr:hover { background: rgba(255, 255, 255, 0.08); }

        .icon-btn {
            background:transparent;
            border:1px solid rgba(255,255,255,0.06);
            padding:6px 8px;
            border-radius:6px;
            cursor:pointer;
            color:white;
            font-size: 12px;
            margin-right: 4px; /* Untuk jarak antar tombol */
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- Table specific styling --- */
        .muted { color: rgba(255,255,255,0.7); font-size:13px; }
        .updated-row {
            background-color: rgba(255, 255, 0, 0.08); /* A subtle yellow tint */
        }
        .updated-row:hover {
            background-color: rgba(255, 255, 0, 0.15); /* Slightly darker on hover */
        }
        .duplicate-entry {
            background-color: rgba(255, 0, 0, 0.15); /* A subtle red tint for duplicates */
            border-left: 4px solid #ef4444; /* Red border on the left */
        }
        .duplicate-entry:hover {
            background-color: rgba(255, 0, 0, 0.25); /* Darker red on hover */
        }

        /* Sortable table headers */
        th[data-sort-by] {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sort-arrow {
            margin-left: 5px;
            font-size: 0.8em;
            vertical-align: middle;
            opacity: 0.5;
            transition: opacity 0.2s ease-in-out;
        }
        .sort-arrow.active { opacity: 1; }
        .sort-arrow.asc::after { content: ' ▲'; }
        .sort-arrow.desc::after { content: ' ▼'; }

        /* --- Modal Styles --- */
        .modal {
            position:fixed;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            background:rgba(0,0,0,0.5);
            z-index:1000;
        }
        .modal-card {
            background: white;
            color: #111827;
            width: 460px; /* Lebih lebar untuk form karyawan */
            max-width: 94%;
            border-radius: 10px;
            padding:20px; /* Lebih banyak padding */
            box-shadow:0 12px 36px rgba(0,0,0,0.4);
        }
        .modal-card h3 { margin:0 0 12px 0; font-size:20px; } /* Lebih besar */
        .form-row { margin-bottom:12px; }
        .form-row label { display:block; font-size:13px; margin-bottom:6px; color:#374151; }
        .form-row input {
            width:100%;
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #d1d5db;
            box-sizing:border-box;
            font-size:14px;
            color: #111827;
        }
        .form-row input::placeholder { color: #6b7280; }
        .hidden { display:none; }

        /* --- Report Box (for Excel Upload) --- */
        #reportBox {
            margin-top: 1rem;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
        }
        #uploadReport {
            white-space: pre-wrap;
            font-size: 14px;
            color: #fbbf24;
        }

        /* --- Footer Styles --- */
        footer {
            text-align: center;
            padding: 1rem;
            font-size: .9rem;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
            box-shadow: 0 -2px 3px rgba(0,0,0,0.1);
        }
        footer a { color: white; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
            nav .brand { margin-bottom: 10px; }
            nav .menu {
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
                margin-bottom: 10px;
                gap: 5px;
            }
            .menu-icon-link { padding: 5px 8px; }
            .right-nav-items {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            .user-info { font-size: 0.8em; }
            nav .menu2 { padding: 0.4rem 0.8rem; font-size: 0.8em; }
            .container { padding: 12px; }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            #searchInput { min-width: unset; width: 100%; }
            .btn, .file-input-label { width: 100%; }
            table { min-width: 600px; } /* Sesuaikan agar tetap readable */
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="main-content-wrapper">
        <div class="container" id="adminUploadContainer">
            <h2>Kelola Data Karyawan</h2>

                 <div class="controls">
                <label for="excelFile" class="file-input-label">⬆️ Unggah Excel</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <button class="btn btn-secondary" id="downloadTemplateBtn">⬇️ Download Template</button> 
                <button class="btn btn-info" id="addEmployeeBtn">➕ Tambah Karyawan</button>
                <button class="btn btn-ghost" id="refreshEmployeeDataBtn">🔄 Refresh Data</button>
                <input type="text" id="searchInput" placeholder="Cari NIK/Nama Karyawan...">
                <button class="btn btn-primary" id="deleteSelectedBtn" style="display:none;">🗑️ Hapus Terpilih (<span id="selectedCount">0</span>)</button>
            </div>


            <div class="status-message" id="pageStatus">Memuat data karyawan...</div>

            <div class="table-wrap">
                <table id="employeesTable">
                    <thead id="employeesTableHead">
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="selectAllCheckbox"></th>
                            <th style="width:50px">No</th>
                            <th data-sort-by="NIK">NIK <span class="sort-arrow"></span></th>
                            <th data-sort-by="Nama">Nama Karyawan <span class="sort-arrow"></span></th>
                            <th data-sort-by="Jabatan">Jabatan <span class="sort-arrow"></span></th>
                            <th data-sort-by="Department">Department <span class="sort-arrow"></span></th>
                            <th data-sort-by="createdAt">Dibuat <span class="sort-arrow"></span></th>
                            <th data-sort-by="updatedAt">Diperbarui <span class="sort-arrow"></span></th>
                            <th style="width:150px">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTbody">
                        <!-- rows inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Report Box for Excel Upload -->
            <div id="reportBox" style="margin-top:1rem; display:none;">
                <div id="uploadReport" style="white-space:pre-wrap; font-size:14px; color:#fbbf24;"></div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button id="downloadReportBtn" class="btn btn-ghost small">
                        ⬇️ Download Report Skipped/Overwritten
                    </button>
                    <button id="discardReportBtn" class="btn btn-ghost small">
                        ❌ Buang Report
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal: Add/Edit Karyawan -->
    <div id="employeeModal" class="modal hidden" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalEmployeeTitle">
            <h3 id="modalEmployeeTitle">Tambah Karyawan</h3>
            <div class="form-row">
                <label for="inputNIK">NIK</label>
                <input id="inputNIK" type="text" placeholder="Nomor Induk Karyawan">
            </div>
            <div class="form-row">
                <label for="inputNama">Nama Karyawan</label>
                <input id="inputNama" type="text" placeholder="Nama Lengkap Karyawan">
            </div>
            <div class="form-row">
                <label for="inputJabatan">Jabatan</label>
                <input id="inputJabatan" type="text" placeholder="Jabatan Karyawan">
            </div>
            <div class="form-row">
                <label for="inputDepartment">Department</label>
                <input id="inputDepartment" type="text" placeholder="Department Karyawan">
            </div>
            <!-- Tambahkan field lain sesuai kebutuhan dari excelData kamu -->

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                <button id="cancelEmployeeBtn" class="btn btn-secondary small">Batal</button> <!-- DIUBAH MENJADI btn-secondary -->
                <button id="saveEmployeeBtn" class="btn btn-primary small">Simpan</button>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script type="module">
        import { initPage } from "./common-ui.js";
        import { auth, db } from "./firebase-config.js";
        import {
            collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc,
            serverTimestamp, query, where, orderBy, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Inisialisasi halaman (ini akan memuat header/footer dan set judul)
        document.addEventListener('DOMContentLoaded', () => {
            initPage("Kelola Data Karyawan", "adminUploadContainer", "admin");
            // Autentikasi dan dapatkan data pengguna
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    currentUserData = userDocSnap.exists() ? userDocSnap.data() : { username: user.email || user.uid };
                } else {
                    currentUserData = null;
                    // Redirect ke login jika tidak ada user
                    // window.location.href = "/login.html"; // Sesuaikan path login
                }
            });
            loadEmployees(); // Muat data karyawan saat halaman pertama kali dibuka
        });

        const XLSX = window.XLSX;
        if (!XLSX) {
            console.error("SheetJS (xlsx.full.min.js) tidak dimuat dengan benar. Pastikan path-nya benar dan dimuat sebelum script ini.");
            setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
        }

        // --- DOM References ---
        const pageStatus = document.getElementById("pageStatus");
        const employeesTbody = document.getElementById("employeesTbody");
        const employeesTableHead = document.getElementById("employeesTableHead");
        const addEmployeeBtn = document.getElementById("addEmployeeBtn");
        const refreshEmployeeDataBtn = document.getElementById("refreshEmployeeDataBtn");
        const searchInput = document.getElementById("searchInput");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");
        const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
        const selectedCountSpan = document.getElementById("selectedCount");

        // Modal elements
        const employeeModal = document.getElementById("employeeModal");
        const modalEmployeeTitle = document.getElementById("modalEmployeeTitle");
        const inputNIK = document.getElementById("inputNIK");
        const inputNama = document.getElementById("inputNama");
        const inputJabatan = document.getElementById("inputJabatan");
        const inputDepartment = document.getElementById("inputDepartment");
        const cancelEmployeeBtn = document.getElementById("cancelEmployeeBtn");
        const saveEmployeeBtn = document.getElementById("saveEmployeeBtn");

        // Excel Upload Elements
        const excelFile = document.getElementById('excelFile');
        // const templateBtn = document.getElementById('templateBtn'); // DIHILANGKAN
        const reportBox = document.getElementById("reportBox");
        const uploadReport = document.getElementById("uploadReport");
        const downloadReportBtn = document.getElementById("downloadReportBtn");
        const discardReportBtn = document.getElementById("discardReportBtn");

        // --- Global State Variables ---
        let allEmployeesData = []; // Semua data karyawan dari Firestore
        let currentDisplayData = []; // Data yang sedang ditampilkan (setelah filter/sort)
        let editingEmployeeId = null; // ID dokumen yang sedang diedit
        let currentSelectedEmployeeIds = new Set(); // ID dokumen yang dipilih untuk hapus banyak
        let sortState = { column: 'createdAt', direction: 'desc' }; // State sorting tabel
        let currentUserData = null; // Informasi user yang sedang login
        let uploadExcelReportData = []; // Data untuk report Excel upload

        // --- Utility Functions ---
        function esc(str) {
            if (str === undefined || str === null) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setStatus(message, type = 'info') {
            pageStatus.textContent = message;
            pageStatus.className = `status-message ${type}`;
        }

        function openEmployeeModal() {
            employeeModal.classList.remove("hidden");
            employeeModal.setAttribute("aria-hidden", "false");
            inputNIK.focus(); // Fokus ke NIK saat modal dibuka
        }

        function closeEmployeeModal() {
            employeeModal.classList.add("hidden");
            employeeModal.setAttribute("aria-hidden", "true");
        }

        // --- Logging Function ---
        async function logEmployeeAction(action, docId, oldData, newData, context = {}) {
            if (!auth.currentUser || !currentUserData) {
                console.warn("Tidak dapat membuat log: Pengguna tidak terautentikasi atau data pengguna tidak tersedia.");
                return;
            }

            const logEntry = {
                collection: "employees_mapping",
                documentId: docId,
                action: action,
                timestamp: serverTimestamp(),
                changedByUid: auth.currentUser.uid,
                changedByName: currentUserData.username || auth.currentUser.email,
                ...context // Tambahkan konteks tambahan seperti 'source: "excel_upload"'
            };

            if (action === "create" || action === "create_from_excel") {
                logEntry.newData = newData;
            } else if (action === "update") {
                const changes = {};
                for (const key in newData) {
                    if (key !== 'updatedAt' && key !== 'updatedBy' && oldData[key] !== newData[key]) {
                        changes[key] = { old: oldData[key], new: newData[key] };
                    }
                }
                logEntry.changes = changes;
                logEntry.oldData = oldData;
                logEntry.newData = newData;
            } else if (action === "delete" || action === "delete_batch") {
                logEntry.oldData = oldData;
            }
            await addDoc(collection(db, "employees_logs"), logEntry);
        }

        // --- Table Rendering Functions ---
        function renderTable(employeesToRender) {
            employeesTbody.innerHTML = "";
            if (employeesToRender.length === 0) {
                employeesTbody.innerHTML = `<tr><td colspan="9" class="muted">Belum ada karyawan terdaftar atau tidak ditemukan.</td></tr>`;
                return;
            }

            let index = 0;
            employeesToRender.forEach(employee => {
                index++;
                const d = employee.data;
                const id = employee.id;

                const createdDate = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : (d.createdAt instanceof Date ? d.createdAt : null);
                const created = createdDate ? createdDate.toLocaleString() : "-";
                const updatedDate = d.updatedAt && d.updatedAt.toDate ? d.updatedAt.toDate() : (d.updatedAt instanceof Date ? d.updatedAt : null);
                const updated = updatedDate ? updatedDate.toLocaleString() : "-";

                const isSelected = currentSelectedEmployeeIds.has(id);
                const tr = document.createElement("tr");
                if (d.updatedAt) { // Untuk perbedaan warna baris terupdate
                    tr.classList.add("updated-row");
                }
                // Jika ada kondisi duplikat NIK, bisa tambahkan kelas 'duplicate-entry' di sini
                // if (isDuplicateNIK(id)) { tr.classList.add("duplicate-entry"); tr.title = "NIK ini duplikat."; }


                tr.innerHTML = `
                    <td><input type="checkbox" class="employee-checkbox" data-id="${id}" ${isSelected ? 'checked' : ''}></td>
                    <td>${index}</td>
                    <td>${esc(d.NIK || '-')}</td>
                    <td>${esc(d.Nama || '-')}</td>
                    <td>${esc(d.Jabatan || '-')}</td>
                    <td>${esc(d.Department || '-')}</td>
                    <td class="muted">${created}</td>
                    <td class="muted">${updated}</td>
                    <td>
                        <button class="icon-btn" data-action="edit" data-id="${id}">✏️ Edit</button>
                        <button class="icon-btn" data-action="delete" data-id="${id}">🗑️ Hapus</button>
                    </td>
                `;
                employeesTbody.appendChild(tr);
            });
            updateSelectAllCheckboxState(); // Update status checkbox select all
            updateDeleteSelectedButtonVisibility(); // Update status tombol hapus banyak
        }

        function updateSelectAllCheckboxState() {
            const allCheckboxes = document.querySelectorAll(".employee-checkbox");
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        function updateDeleteSelectedButtonVisibility() {
            selectedCountSpan.textContent = currentSelectedEmployeeIds.size;
            if (currentSelectedEmployeeIds.size > 0) {
                deleteSelectedBtn.style.display = "inline-block";
            } else {
                deleteSelectedBtn.style.display = "none";
            }
        }

        function applySortAndFilter() {
            let dataToProcess = [...allEmployeesData];

            // 1. Apply filter
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm !== "") {
                dataToProcess = dataToProcess.filter(employee => {
                    const nik = (employee.data.NIK || "").toLowerCase();
                    const nama = (employee.data.Nama || "").toLowerCase();
                    const jabatan = (employee.data.Jabatan || "").toLowerCase();
                    const Department = (employee.data.Department || "").toLowerCase();
                    return nik.includes(searchTerm) || nama.includes(searchTerm) || jabatan.includes(searchTerm) || Department.includes(searchTerm);
                });
            }

            // 2. Apply sort
            if (sortState.column) {
                dataToProcess.sort((a, b) => {
                    let valA, valB;
                    if (['NIK', 'Nama', 'Jabatan', 'Department'].includes(sortState.column)) {
                        valA = (a.data[sortState.column] || '').toLowerCase();
                        valB = (b.data[sortState.column] || '').toLowerCase();
                    } else if (sortState.column === 'createdAt' || sortState.column === 'updatedAt') {
                        valA = a.data[sortState.column] ? (a.data[sortState.column].toDate ? a.data[sortState.column].toDate().getTime() : new Date(a.data[sortState.column]).getTime()) : 0;
                        valB = b.data[sortState.column] ? (b.data[sortState.column].toDate ? b.data[sortState.column].toDate().getTime() : new Date(b.data[sortState.column]).getTime()) : 0;
                    } else {
                        valA = a.data[sortState.column];
                        valB = b.data[sortState.column];
                    }

                    if (typeof valA === 'string' && (valA === null || valA === undefined || valA === '')) valA = sortState.direction === 'asc' ? '' : 'zzzzz';
                    if (typeof valB === 'string' && (valB === null || valB === undefined || valB === '')) valB = sortState.direction === 'asc' ? '' : 'zzzzz';

                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            currentDisplayData = dataToProcess;
            renderTable(currentDisplayData);
            updateSortArrows();
        }

        function updateSortArrows() {
            employeesTableHead.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.classList.remove('active', 'asc', 'desc');
            });

            const activeTh = employeesTableHead.querySelector(`th[data-sort-by="${sortState.column}"]`);
            if (activeTh) {
                const activeArrow = activeTh.querySelector('.sort-arrow');
                if (activeArrow) {
                    activeArrow.classList.add('active', sortState.direction);
                }
            }
        }

        // Helper to check for duplicate NIK
        async function checkDuplicateNIK(nik, currentDocId = null) {
            const q = query(collection(db, "employees_mapping"), where("NIK", "==", nik));
            const snap = await getDocs(q);
            let isDuplicate = false;
            snap.forEach(doc => {
                if (doc.id !== currentDocId) {
                    isDuplicate = true;
                }
            });
            return isDuplicate;
        }

        // --- Main Data Loading Function ---
        async function loadEmployees() {
            setStatus("Memuat data karyawan...", 'info');
            try {
                // Default sorting order
                const q = query(collection(db, "employees_mapping"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);

                allEmployeesData = [];
                snap.forEach(docSnap => {
                    allEmployeesData.push({ id: docSnap.id, data: docSnap.data() });
                });

                applySortAndFilter(); // Terapkan sorting dan filter awal
                setStatus(`Selesai memuat (${allEmployeesData.length} karyawan).`, 'success');
            } catch (err) {
                console.error(err);
                setStatus("Gagal memuat data karyawan. Cek konsol.", 'error');
                employeesTbody.innerHTML = `<tr><td colspan="9" class="muted">Error saat memuat data.</td></tr>`;
            }
        }

        // --- Event Listeners ---

        // Refresh Data Karyawan
        refreshEmployeeDataBtn.addEventListener("click", () => {
            searchInput.value = ""; // Clear search
            sortState = { column: 'createdAt', direction: 'desc' }; // Reset sort
            currentSelectedEmployeeIds.clear(); // Clear selections
            loadEmployees();
        });

        // Add New Employee Button
        addEmployeeBtn.addEventListener("click", () => {
            editingEmployeeId = null;
            modalEmployeeTitle.textContent = "Tambah Karyawan Baru";
            inputNIK.value = "";
            inputNIK.disabled = false; // NIK bisa diisi saat tambah baru
            inputNama.value = "";
            inputJabatan.value = "";
            inputDepartment.value = "";
            // ... clear any other fields
            openEmployeeModal();
        });

        // Cancel Employee Modal Button
        cancelEmployeeBtn.addEventListener("click", closeEmployeeModal);

        // Save Employee (Add/Edit)
        saveEmployeeBtn.addEventListener("click", async () => {
            const nik = inputNIK.value.trim();
            const nama = inputNama.value.trim();
            const jabatan = inputJabatan.value.trim();
            const Department = inputDepartment.value.trim();

            if (!nik || !nama) {
                alert("NIK dan Nama Karyawan wajib diisi.");
                return;
            }

            saveEmployeeBtn.disabled = true;
            try {
                const employeeData = {
                    NIK: nik,
                    Nama: nama,
                    Jabatan: jabatan,
                    Department: Department,
                    // ... tambahkan field lain yang relevan
                };

                if (editingEmployeeId) { // Edit Existing
                    const ref = doc(db, "employees_mapping", editingEmployeeId);
                    const beforeSnap = await getDoc(ref);
                    const beforeData = beforeSnap.exists() ? beforeSnap.data() : {};

                    await updateDoc(ref, {
                        ...employeeData,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUserData?.username || auth.currentUser.uid
                    });
                    await logEmployeeAction("update", editingEmployeeId, beforeData, employeeData);

                    setStatus("Data karyawan berhasil diperbarui.", 'success');
                } else { // Add New
                    // Check for duplicate NIK before adding
                    const isDuplicate = await checkDuplicateNIK(nik);
                    if (isDuplicate) {
                        alert("NIK ini sudah ada. Harap gunakan NIK yang unik.");
                        saveEmployeeBtn.disabled = false;
                        return;
                    }

                    // Use NIK as the document ID
                    await setDoc(doc(db, "employees_mapping", nik), {
                        ...employeeData,
                        createdAt: serverTimestamp(),
                        createdBy: currentUserData?.username || auth.currentUser.uid
                    });
                    await logEmployeeAction("create", nik, null, employeeData);

                    setStatus("Karyawan baru berhasil ditambahkan.", 'success');
                }
                closeEmployeeModal();
                await loadEmployees(); // Reload data to show changes
            } catch (err) {
                console.error(err);
                alert("Gagal menyimpan data karyawan: " + (err.message || err));
                setStatus("Gagal menyimpan.", 'error');
            } finally {
                saveEmployeeBtn.disabled = false;
            }
        });

        // Table Body Click Listener (for Edit/Delete single item)
        employeesTbody.addEventListener("click", async (ev) => {
            const btn = ev.target.closest("button");
            if (!btn) return;
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (!action || !id) return;

            if (action === "edit") {
                try {
                    const snap = await getDoc(doc(db, "employees_mapping", id));
                    if (!snap.exists()) {
                        alert("Data karyawan tidak ditemukan.");
                        return;
                    }
                    const d = snap.data();
                    editingEmployeeId = id;
                    modalEmployeeTitle.textContent = "Edit Karyawan";
                    inputNIK.value = d.NIK || "";
                    inputNIK.disabled = true; // NIK tidak bisa diedit setelah dibuat
                    inputNama.value = d.Nama || "";
                    inputJabatan.value = d.Jabatan || "";
                    inputDepartment.value = d.Department || "";
                    // ... fill other fields
                    openEmployeeModal();
                } catch (err) {
                    console.error(err);
                    alert("Gagal memuat data karyawan untuk edit.");
                }
            } else if (action === "delete") {
                if (!confirm("Yakin ingin menghapus karyawan ini? Tindakan ini tidak bisa dibatalkan.")) return;

                try {
                    const ref = doc(db, "employees_mapping", id);
                    const beforeSnap = await getDoc(ref);
                    if (!beforeSnap.exists()) {
                        alert("Karyawan sudah tidak ada.");
                        return;
                    }
                    const before = beforeSnap.data(); // Simpan data sebelum dihapus

                    await deleteDoc(ref);
                    await logEmployeeAction("delete", id, before, null);

                    setStatus("Karyawan berhasil dihapus.", 'success');
                    await loadEmployees(); // Reload data to show changes
                    currentSelectedEmployeeIds.delete(id); // Hapus dari seleksi jika ada
                    updateDeleteSelectedButtonVisibility();
                } catch (err) {
                    console.error(err);
                    alert("Gagal menghapus karyawan: " + (err.message || err));
                    setStatus("Gagal menghapus.", 'error');
                }
            }
        });

        // Individual Checkbox Click Listener
        employeesTbody.addEventListener("change", (e) => {
            if (e.target.classList.contains("employee-checkbox")) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    currentSelectedEmployeeIds.add(id);
                } else {
                    currentSelectedEmployeeIds.delete(id);
                }
                updateSelectAllCheckboxState();
                updateDeleteSelectedButtonVisibility();
            }
        });

        // Select All Checkbox
        selectAllCheckbox.addEventListener("change", (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll(".employee-checkbox").forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    currentSelectedEmployeeIds.add(checkbox.dataset.id);
                } else {
                    currentSelectedEmployeeIds.delete(checkbox.dataset.id);
                }
            });
            updateDeleteSelectedButtonVisibility();
        });

        // Delete Selected Button
        deleteSelectedBtn.addEventListener("click", async () => {
            if (currentSelectedEmployeeIds.size === 0) {
                alert("Tidak ada karyawan yang dipilih untuk dihapus.");
                return;
            }
            if (!confirm(`Yakin ingin menghapus ${currentSelectedEmployeeIds.size} karyawan terpilih? Tindakan ini tidak bisa dibatalkan.`)) return;

            setStatus(`Menghapus ${currentSelectedEmployeeIds.size} karyawan terpilih...`, 'info');
            deleteSelectedBtn.disabled = true;
            const batch = writeBatch(db);
            let deletedCount = 0;

            try {
                for (const id of currentSelectedEmployeeIds) {
                    const ref = doc(db, "employees_mapping", id);
                    const beforeSnap = await getDoc(ref);
                    if (beforeSnap.exists()) {
                        batch.delete(ref);
                        await logEmployeeAction("delete_batch", id, beforeSnap.data(), null);
                        deletedCount++;
                    } else {
                        console.warn(`Dokumen dengan ID ${id} tidak ditemukan, mungkin sudah dihapus.`);
                    }
                }
                await batch.commit();
                setStatus(`${deletedCount} karyawan berhasil dihapus.`, 'success');
                currentSelectedEmployeeIds.clear(); // Clear selection
                await loadEmployees(); // Reload data
            } catch (err) {
                console.error(err);
                alert("Gagal menghapus karyawan terpilih: " + (err.message || err));
                setStatus("Gagal menghapus beberapa karyawan.", 'error');
            } finally {
                deleteSelectedBtn.disabled = false;
            }
        });

        // Search Input Listener
        searchInput.addEventListener("input", () => {
            applySortAndFilter();
        });

        // Table Header Click Listener (for Sorting)
        employeesTableHead.addEventListener("click", (e) => {
            const targetTh = e.target.closest("th[data-sort-by]");
            if (!targetTh) return;

            const column = targetTh.dataset.sortBy;
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            applySortAndFilter();
        });
 // ... (Kode yang sudah ada di bagian Excel Upload Elements)
        const excelFile = document.getElementById('excelFile');
        // const templateBtn = document.getElementById('templateBtn'); // DIHILANGKAN - ini dulu, sekarang kita punya id baru
        const reportBox = document.getElementById("reportBox");
        const uploadReport = document.getElementById("uploadReport");
        const downloadReportBtn = document.getElementById("downloadReportBtn");
        const discardReportBtn = document.getElementById("discardReportBtn");

        // --- New: Template Download Elements ---
        const downloadTemplateBtn = document.getElementById("downloadTemplateBtn"); // Referensi tombol baru

        // --- New: Template Download Listener ---
        downloadTemplateBtn.addEventListener("click", () => {
            if (typeof XLSX === 'undefined') {
                setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
                return;
            }

            const headers = [
                "ID Mesin",
                "NIK Sebelumnya",
                "NIK",
                "Nama",
                "Status",
                "Perusahaan",
                "Department", // Perbaiki menjadi "Department" agar konsisten dengan field lain
                "Jabatan",
                "Sidik Jari"
            ];

            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Karyawan");
            XLSX.writeFile(wb, "template_data_karyawan.xlsx");

            setStatus("Template Excel berhasil diunduh.", 'success');
        });

        // excelFile.addEventListener sekarang berfungsi untuk langsung memproses dan mengupload data
        // ... (Sisa kode JS Anda)
        // --- Excel Upload Functions ---
        // excelFile.addEventListener sekarang berfungsi untuk langsung memproses dan mengupload data
        excelFile.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                setStatus("Kesalahan: Library Excel tidak dimuat. Cek konsol browser Anda.", 'error');
                return;
            }

            setStatus("Membaca file Excel...", 'info');
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert to JSON with header row as keys
                    const rawExcelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                    if (rawExcelData.length < 2) { // Minimum 1 header + 1 data row
                        setStatus("File Excel kosong atau hanya berisi header.", 'error');
                        excelFile.value = ""; // Reset file input
                        return;
                    }

                    const headers = rawExcelData[0].map(h => String(h).trim()); // Trim headers
                    const rows = rawExcelData.slice(1);

                    let newAddedCount = 0;
                    let uploadSkippedCount = 0;
                    let uploadOverwrittenCount = 0;
                    uploadExcelReportData = []; // Reset report data

                    // Fetch existing NIKs for conflict checking
                    const existingNIKsSnap = await getDocs(collection(db, "employees_mapping"));
                    const existingNIKsMap = new Map(); // NIK -> doc.data()
                    existingNIKsSnap.forEach(doc => {
                        existingNIKsMap.set(doc.id, doc.data()); // Assuming NIK is doc.id
                    });

                    const batch = writeBatch(db);
                    let currentBatchOps = 0;
                    const BATCH_MAX_OPS = 400; // Firestore limit 500 ops per batch, save some for log

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        let obj = {};
                        let isEmptyRow = true;
                        headers.forEach((header, index) => {
                            let value = row[index];
                            if (typeof value === 'string') {
                                value = value.trim();
                            }
                            if (value !== undefined && value !== null && value !== '') {
                                isEmptyRow = false;
                            }
                            obj[header] = value;
                        });

                        if (isEmptyRow) {
                            uploadSkippedCount++;
                            uploadExcelReportData.push({
                                NIK: obj['NIK'] || '-',
                                Nama: obj['Nama'] || '-',
                                Reason: "Baris kosong dilewati"
                            });
                            continue;
                        }

                        const nik = String(obj['NIK'] || '').trim();
                        if (!nik) {
                            uploadSkippedCount++;
                            uploadExcelReportData.push({
                                NIK: obj['NIK'] || '-',
                                Nama: obj['Nama'] || '-',
                                Reason: "NIK kosong, baris dilewati"
                            });
                            continue;
                        }

                        const dataToSave = {};
                        // Filter out undefined/null/empty string values for Firestore
                        for (const key in obj) {
                            if (obj.hasOwnProperty(key) && obj[key] !== undefined && obj[key] !== null && String(obj[key]).trim() !== '') {
                                dataToSave[key] = obj[key];
                            }
                        }

                        // Add common metadata fields
                        const commonMetadata = {
                            updatedAt: serverTimestamp(),
                            updatedBy: currentUserData?.username || auth.currentUser.uid,
                            source: "excel_upload"
                        };

                        if (existingNIKsMap.has(nik)) {
                            // NIK already exists, this is an update/overwrite
                            const oldData = existingNIKsMap.get(nik);
                            const updatedData = { ...oldData, ...dataToSave, ...commonMetadata }; // Merge new data with old
                            batch.set(doc(collection(db, "employees_mapping"), nik), updatedData);
                            await logEmployeeAction("update_from_excel", nik, oldData, updatedData, { source: "excel_upload" });
                            uploadOverwrittenCount++;
                        } else {
                            // New NIK, this is a creation
                            const newData = { ...dataToSave, createdAt: serverTimestamp(), createdBy: commonMetadata.updatedBy, ...commonMetadata };
                            batch.set(doc(collection(db, "employees_mapping"), nik), newData);
                            await logEmployeeAction("create_from_excel", nik, null, newData, { source: "excel_upload" });
                            newAddedCount++;
                        }
                        currentBatchOps++;

                        if (currentBatchOps >= BATCH_MAX_OPS) {
                            await batch.commit();
                            setStatus(`Mengunggah batch... Baru: ${newAddedCount}, Diubah: ${uploadOverwrittenCount}.`, 'info');
                            currentBatchOps = 0;
                            // Start a new batch
                            // Note: `batch` diinisialisasi di awal dan di-commit di dalam loop.
                            // Untuk memulai batch baru, kita perlu membuat instance `writeBatch(db)` baru di sini.
                            // Atau, struktur ulang agar commit terjadi di luar loop for dan hanya commit sekali.
                            // Untuk kasus ini, karena `writeBatch` tidak bisa di-reassign,
                            // kita akan commit sisa operasi setelah loop selesai.
                            // Opsinya adalah membuat array batch, lalu commit satu per satu.
                            // Tapi untuk sekarang, biarkan logic ini dan commit sisa di akhir.
                        }
                    } // End of for loop

                    // Commit any remaining operations in the last batch
                    if (currentBatchOps > 0) {
                        await batch.commit();
                    }

                    let msg = `Unggah Excel selesai.\n`;
                    if (newAddedCount > 0) msg += `Ditambahkan baru: ${newAddedCount}.\n`;
                    if (uploadOverwrittenCount > 0) msg += `Data diubah/ditimpa: ${uploadOverwrittenCount}.\n`;
                    if (uploadSkippedCount > 0) msg += `Baris dilewati: ${uploadSkippedCount}.`;

                    if (uploadExcelReportData.length > 0) {
                        msg += `\n\nBeberapa baris dilewati atau diubah. Lihat detail di Report Box.`;
                        reportBox.style.display = "block";
                        downloadReportBtn.dataset.skipped = JSON.stringify(uploadExcelReportData);
                    } else {
                        reportBox.style.display = "none";
                    }

                    uploadReport.textContent = msg;
                    setStatus("Unggah Excel selesai.", 'success');
                    await loadEmployees(); // Reload main table
                    excelFile.value = ""; // Reset file input
                } catch (error) {
                    setStatus(`Gagal memproses file Excel: ${error.message}. Pastikan format file benar dan kolom NIK ada.`, 'error');
                    console.error(error);
                } finally {
                    excelFile.value = ""; // Selalu reset input file
                }
            };
            reader.onerror = (error) => {
                setStatus(`Terjadi kesalahan saat membaca file: ${error}`, 'error');
                console.error(error);
            };
            reader.readAsArrayBuffer(file);
        });
    
        // Download Skipped/Overwritten Report
        downloadReportBtn.addEventListener("click", () => {
            const reportList = JSON.parse(downloadReportBtn.dataset.skipped || "[]");
            if (reportList.length === 0) return;

            const wbReport = XLSX.utils.book_new();
            const wsReport = XLSX.utils.aoa_to_sheet([
                ["NIK", "Nama", "Alasan"],
                ...reportList.map(item => [item.NIK, item.Nama, item.Reason])
            ]);
            XLSX.utils.book_append_sheet(wbReport, wsReport, "Report Upload");
            XLSX.writeFile(wbReport, "report_upload_karyawan.xlsx");

            reportBox.style.display = "none";
            uploadReport.textContent = "";
        });

        // Discard Report
        discardReportBtn.addEventListener("click", () => {
            if (confirm("Yakin mau buang report ini tanpa download? Report akan hilang permanen.")) {
                reportBox.style.display = "none";
                uploadReport.textContent = "";
                uploadExcelReportData = [];
                downloadReportBtn.dataset.skipped = "[]";
            }
        });

    </script>
</body>
</html>


